-- Hitbox Script
-- Upload this to GitHub and use the raw link

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local LocalPlayer = Players.LocalPlayer

-- Get settings from global
local HitboxSettings = getgenv().HitboxSettings
if not HitboxSettings then
    warn("HitboxSettings not found - load Combat GUI first")
    return
end

local hitboxConnection = nil
local originalHitboxSizes = {}
local previewBox = nil
local customHitboxParts = {}

local function isOnSameTeam(player)
    if not HitboxSettings.TeamCheck then return false end
    
    if player.Team and LocalPlayer.Team and player.Team == LocalPlayer.Team then
        return true
    end
    
    return false
end

local function calculateHitboxSize()
    -- Base HumanoidRootPart size
    local baseSize = Vector3.new(2, 2, 1)
    
    -- Calculate total expansion for each axis
    local totalX = baseSize.X + HitboxSettings.HitboxLeft + HitboxSettings.HitboxRight
    local totalY = baseSize.Y + HitboxSettings.HitboxUp + HitboxSettings.HitboxDown
    local totalZ = baseSize.Z + HitboxSettings.HitboxFront + HitboxSettings.HitboxBack
    
    return Vector3.new(totalX, totalY, totalZ)
end

local function calculateHitboxOffset()
    -- Calculate offset to shift hitbox in the correct direction
    -- If Left=10, Right=0: need to shift LEFT by 5 (half of 10)
    -- If Left=0, Right=10: need to shift RIGHT by 5 (half of 10)
    -- Formula: offset = (expansion in positive direction - expansion in negative direction) / 2
    
    -- X axis: Right is positive, Left is negative
    local offsetX = (HitboxSettings.HitboxRight - HitboxSettings.HitboxLeft) / 2
    
    -- Y axis: Up is positive, Down is negative
    local offsetY = (HitboxSettings.HitboxUp - HitboxSettings.HitboxDown) / 2
    
    -- Z axis: Front is negative (forward in Roblox), Back is positive
    local offsetZ = (HitboxSettings.HitboxBack - HitboxSettings.HitboxFront) / 2
    
    return Vector3.new(offsetX, offsetY, offsetZ)
end

local function createPreviewBox()
    if previewBox then return end
    
    previewBox = Instance.new("Part")
    previewBox.Name = "HitboxPreview"
    previewBox.Anchored = true
    previewBox.CanCollide = false
    previewBox.Material = Enum.Material.ForceField
    previewBox.Color = Color3.fromRGB(255, 0, 0)
    previewBox.Transparency = HitboxSettings.PreviewTransparency
    previewBox.Size = calculateHitboxSize()
    
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = LocalPlayer.Character.HumanoidRootPart
        if HitboxSettings.UsePositionOffset then
            previewBox.CFrame = hrp.CFrame * CFrame.new(
                HitboxSettings.HitboxPosX,
                HitboxSettings.HitboxPosY,
                HitboxSettings.HitboxPosZ
            )
        else
            previewBox.CFrame = hrp.CFrame * CFrame.new(5, 0, 0)
        end
    end
    
    previewBox.Parent = workspace
end

local function updatePreviewBox()
    if not previewBox then return end
    
    previewBox.Size = calculateHitboxSize()
    previewBox.Transparency = HitboxSettings.PreviewTransparency
    
    if LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = LocalPlayer.Character.HumanoidRootPart
        if HitboxSettings.UsePositionOffset then
            previewBox.CFrame = hrp.CFrame * CFrame.new(
                HitboxSettings.HitboxPosX,
                HitboxSettings.HitboxPosY,
                HitboxSettings.HitboxPosZ
            )
        else
            previewBox.CFrame = hrp.CFrame * CFrame.new(5, 0, 0)
        end
    end
end

local function removePreviewBox()
    if previewBox then
        previewBox:Destroy()
        previewBox = nil
    end
end

-- Position offset mode (alternative, not recommended)
local function createCustomHitbox(player, character)
    if customHitboxParts[player] then
        if customHitboxParts[player].part then
            customHitboxParts[player].part:Destroy()
        end
        customHitboxParts[player] = nil
    end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local customHitbox = Instance.new("Part")
    customHitbox.Name = "CustomHitbox"
    customHitbox.Size = calculateHitboxSize()
    customHitbox.Transparency = HitboxSettings.HitboxTransparency
    customHitbox.CanCollide = true
    customHitbox.Anchored = false
    customHitbox.Massless = true
    customHitbox.Material = Enum.Material.ForceField
    customHitbox.Color = Color3.fromRGB(255, 0, 0)
    
    -- Position with offset
    local offset = Vector3.new(0, 0, 0)
    if HitboxSettings.UsePositionOffset then
        offset = Vector3.new(
            HitboxSettings.HitboxPosX,
            HitboxSettings.HitboxPosY,
            HitboxSettings.HitboxPosZ
        )
    else
        offset = calculateHitboxOffset()
    end
    
    customHitbox.CFrame = hrp.CFrame * CFrame.new(offset)
    customHitbox.Parent = character
    
    -- Use Weld instead of AlignPosition
    local weld = Instance.new("Weld")
    weld.Part0 = hrp
    weld.Part1 = customHitbox
    weld.C0 = CFrame.new(offset)
    weld.Parent = customHitbox
    
    customHitboxParts[player] = {
        part = customHitbox,
        weld = weld,
        offset = offset
    }
    
    if not originalHitboxSizes[player] then
        originalHitboxSizes[player] = hrp.Size
    end
    
    -- Make original HRP invisible and non-collidable
    hrp.Transparency = 1
    hrp.CanCollide = false
end

local function removeCustomHitbox(player)
    if customHitboxParts[player] then
        if customHitboxParts[player].part then
            customHitboxParts[player].part:Destroy()
        end
        customHitboxParts[player] = nil
    end
    
    -- Restore HRP
    if player.Character then
        local hrp = player.Character:FindFirstChild("HumanoidRootPart")
        if hrp and originalHitboxSizes[player] then
            hrp.Transparency = 0
            hrp.CanCollide = true
            hrp.Size = originalHitboxSizes[player]
        end
    end
end

local function updateCustomHitbox(player, character)
    if not customHitboxParts[player] then return end
    
    local hrp = character:FindFirstChild("HumanoidRootPart")
    if not hrp then return end
    
    local customHitbox = customHitboxParts[player].part
    local weld = customHitboxParts[player].weld
    
    -- Update size
    customHitbox.Size = calculateHitboxSize()
    customHitbox.Transparency = HitboxSettings.HitboxTransparency
    
    -- Update offset
    local offset = Vector3.new(0, 0, 0)
    if HitboxSettings.UsePositionOffset then
        offset = Vector3.new(
            HitboxSettings.HitboxPosX,
            HitboxSettings.HitboxPosY,
            HitboxSettings.HitboxPosZ
        )
    else
        offset = calculateHitboxOffset()
    end
    
    weld.C0 = CFrame.new(offset)
    customHitboxParts[player].offset = offset
end

local function applyHitbox()
    if not HitboxSettings.Enabled then return end
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character then
            if isOnSameTeam(player) then
                removeCustomHitbox(player)
                continue
            end
            
            local character = player.Character
            local hrp = character:FindFirstChild("HumanoidRootPart")
            
            if hrp then
                -- Always use custom hitbox part for directional control
                if not customHitboxParts[player] then
                    createCustomHitbox(player, character)
                else
                    updateCustomHitbox(player, character)
                end
            end
        end
    end
end

local function restoreHitboxes()
    -- Remove all custom hitboxes
    for player, _ in pairs(customHitboxParts) do
        removeCustomHitbox(player)
    end
    customHitboxParts = {}
    originalHitboxSizes = {}
end

-- Main loop
local function startHitbox()
    if hitboxConnection then return end
    
    createPreviewBox()
    
    hitboxConnection = RunService.Heartbeat:Connect(function()
        pcall(applyHitbox)
        pcall(updatePreviewBox)
    end)
end

local function stopHitbox()
    if hitboxConnection then
        hitboxConnection:Disconnect()
        hitboxConnection = nil
    end
    removePreviewBox()
    restoreHitboxes()
end

-- Export functions
getgenv().HitboxControl = {
    Start = startHitbox,
    Stop = stopHitbox
}

print("Hitbox Script Loaded!")
return true
