-- RPM Tool Module
-- Spins selected parts at adjustable RPM with axis selection

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local RPMToolModule = {}

-- Variables
local spinEnabled = false
local spinRPM = 10
local spinAxis = "Vertical" -- "Vertical" or "Horizontal"
local spinParts = {}
local spinUpdateConnection = nil

-- Reference to get selected parts from other tools
local getSelectedPartsFn = nil

local function applySpinToSelectedParts()
    -- Clear existing spin parts
    for _, data in ipairs(spinParts) do
        if data.part and data.part.Parent and data.bav and data.bav.Parent then
            data.bav:Destroy()
        end
    end
    spinParts = {}
    
    -- Get selected parts from MoveTool or RotateTool
    local selectedParts = {}
    if getSelectedPartsFn then
        selectedParts = getSelectedPartsFn()
    end
    
    if #selectedParts == 0 then
        warn("No parts selected. Use Move Tool or Rotate Tool to select parts first.")
        return false
    end
    
    for _, part in ipairs(selectedParts) do
        if part and part.Parent then
            -- Remove existing BodyAngularVelocity
            for _, child in ipairs(part:GetChildren()) do
                if child:IsA("BodyAngularVelocity") and child.Name == "SpinVelocity" then
                    child:Destroy()
                end
            end
            
            -- Create BodyAngularVelocity for spinning
            local bav = Instance.new("BodyAngularVelocity")
            bav.Name = "SpinVelocity"
            bav.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
            bav.AngularVelocity = Vector3.new(0, 0, 0)
            bav.P = 10000
            bav.Parent = part
            
            table.insert(spinParts, {
                part = part,
                bav = bav
            })
        end
    end
    
    return #spinParts > 0
end

local function updateSpinVelocity()
    if not spinEnabled then return end
    
    -- Convert RPM to radians per second
    local radiansPerSecond = (spinRPM * 2 * math.pi) / 60
    
    for _, data in ipairs(spinParts) do
        if data.part and data.part.Parent and data.bav and data.bav.Parent then
            if spinAxis == "Vertical" then
                -- Spin on Y axis (vertical)
                data.bav.AngularVelocity = Vector3.new(0, radiansPerSecond, 0)
            else
                -- Spin on X axis (horizontal)
                data.bav.AngularVelocity = Vector3.new(radiansPerSecond, 0, 0)
            end
        end
    end
end

local function startSpinUpdate()
    if spinUpdateConnection then return end
    
    spinUpdateConnection = RunService.Heartbeat:Connect(function()
        if spinEnabled then
            updateSpinVelocity()
        end
    end)
end

local function stopSpinUpdate()
    if spinUpdateConnection then
        spinUpdateConnection:Disconnect()
        spinUpdateConnection = nil
    end
end

local function clearSpinFromAllParts()
    for _, data in ipairs(spinParts) do
        if data.part and data.part.Parent then
            if data.bav then data.bav:Destroy() end
        end
    end
    spinParts = {}
    stopSpinUpdate()
end

-- Public Functions
function RPMToolModule.Enable()
    if spinEnabled then return end
    
    local success = applySpinToSelectedParts()
    if not success then
        return false
    end
    
    spinEnabled = true
    startSpinUpdate()
    return true
end

function RPMToolModule.Disable()
    spinEnabled = false
    clearSpinFromAllParts()
end

function RPMToolModule.IsEnabled()
    return spinEnabled
end

function RPMToolModule.SetRPM(value)
    spinRPM = value
end

function RPMToolModule.GetRPM()
    return spinRPM
end

function RPMToolModule.SetAxis(axis)
    spinAxis = axis
end

function RPMToolModule.GetAxis()
    return spinAxis
end

function RPMToolModule.SetGetSelectedPartsFunction(fn)
    getSelectedPartsFn = fn
end

return RPMToolModule
