-- Misc Module
-- Loads tools from GitHub and provides Reset Rotation & Clear All Forces

local HttpService = game:GetService("HttpService")

local MiscModule = {}

-- GitHub URLs for tools
local ToolURLs = {
    MoveTool = "https://raw.githubusercontent.com/givenship/Unanchor.euva/refs/heads/main/MoveTool",
    RotateTool = "https://raw.githubusercontent.com/givenship/Unanchor.euva/refs/heads/main/RotateTool",
    RingShape = "https://raw.githubusercontent.com/givenship/Unanchor.euva/refs/heads/main/RingShape",
    RPMTool = "https://raw.githubusercontent.com/givenship/Unanchor.euva/refs/heads/main/RPMTool"
}

-- Loaded tools storage
local LoadedTools = {}

-- Function to load tool from GitHub
local function loadTool(toolName, url)
    if LoadedTools[toolName] then
        return LoadedTools[toolName]
    end
    
    local success, result = pcall(function()
        return game:HttpGet(url)
    end)
    
    if success then
        local toolFunc, err = loadstring(result)
        if toolFunc then
            local tool = toolFunc()
            LoadedTools[toolName] = tool
            return tool
        else
            warn("Error loading " .. toolName .. ": " .. tostring(err))
            return nil
        end
    else
        warn("Failed to download " .. toolName)
        return nil
    end
end

function MiscModule.CreateUI(parent)
    local miscContent = Instance.new("ScrollingFrame")
    miscContent.Size = UDim2.new(1, 0, 1, 0)
    miscContent.BackgroundTransparency = 1
    miscContent.BorderSizePixel = 0
    miscContent.ScrollBarThickness = 4
    miscContent.Parent = parent
    
    local yPos = 10
    
    local function createButton(name, position, color, callback)
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, -20, 0, 35)
        button.Position = UDim2.new(0, 10, 0, position)
        button.BackgroundColor3 = color or Color3.fromRGB(60, 60, 60)
        button.BorderSizePixel = 0
        button.Text = name
        button.Font = Enum.Font.GothamBold
        button.TextSize = 14
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.Parent = miscContent
        
        button.MouseButton1Click:Connect(callback)
        return button, position + 45
    end
    
    local function createSlider(name, position, minVal, maxVal, currentValue, callback)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 50)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = miscContent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0, 120, 0, 20)
        label.Position = UDim2.new(0, 0, 0, 5)
        label.BackgroundTransparency = 1
        label.Text = name .. ": " .. currentValue
        label.Font = Enum.Font.GothamBold
        label.TextSize = 12
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        local sliderBg = Instance.new("Frame")
        sliderBg.Size = UDim2.new(1, -130, 0, 20)
        sliderBg.Position = UDim2.new(0, 125, 0, 25)
        sliderBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        sliderBg.BorderSizePixel = 1
        sliderBg.BorderColor3 = Color3.fromRGB(255, 255, 255)
        sliderBg.Parent = container
        
        local sliderFill = Instance.new("Frame")
        sliderFill.Size = UDim2.new((currentValue - minVal) / (maxVal - minVal), 0, 1, 0)
        sliderFill.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
        sliderFill.BorderSizePixel = 0
        sliderFill.Parent = sliderBg
        
        local sliderButton = Instance.new("TextButton")
        sliderButton.Size = UDim2.new(1, 0, 1, 0)
        sliderButton.BackgroundTransparency = 1
        sliderButton.Text = ""
        sliderButton.Parent = sliderBg
        
        local dragging = false
        
        sliderButton.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        game:GetService("UserInputService").InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        game:GetService("RunService").RenderStepped:Connect(function()
            if dragging then
                local mousePos = game:GetService("UserInputService"):GetMouseLocation()
                local relativeX = math.clamp(mousePos.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
                local percentage = relativeX / sliderBg.AbsoluteSize.X
                local value = minVal + (maxVal - minVal) * percentage
                
                if maxVal - minVal <= 10 then
                    value = math.floor(value * 10) / 10
                else
                    value = math.floor(value)
                end
                
                sliderFill.Size = UDim2.new((value - minVal) / (maxVal - minVal), 0, 1, 0)
                label.Text = name .. ": " .. value
                
                if callback then callback(value) end
            end
        end)
        
        return position + 60
    end
    
    -- PART CONTROLLER Section
    local controllerTitle = Instance.new("TextLabel")
    controllerTitle.Size = UDim2.new(1, -20, 0, 30)
    controllerTitle.Position = UDim2.new(0, 10, 0, yPos)
    controllerTitle.BackgroundTransparency = 1
    controllerTitle.Text = "PART CONTROLLER"
    controllerTitle.Font = Enum.Font.GothamBlack
    controllerTitle.TextSize = 16
    controllerTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    controllerTitle.TextXAlignment = Enum.TextXAlignment.Left
    controllerTitle.Parent = miscContent
    yPos = yPos + 40
    
    -- Declare button variables
    local moveToolBtn
    local rotateToolBtn
    local ringBtn
    local spinBtn
    
    -- Move Tool Button
    moveToolBtn, yPos = createButton("Move Tool", yPos, Color3.fromRGB(100, 100, 100), function()
        local moveTool = loadTool("MoveTool", ToolURLs.MoveTool)
        if not moveTool then return end
        
        if moveTool.IsEnabled() then
            moveTool.Disable()
            moveToolBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        else
            -- Disable other tools
            if LoadedTools.RotateTool and LoadedTools.RotateTool.IsEnabled() then
                LoadedTools.RotateTool.Disable()
                rotateToolBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
            end
            
            moveTool.Enable()
            moveToolBtn.BackgroundColor3 = Color3.fromRGB(50, 180, 220)
        end
    end)
    
    -- Rotate Tool Button
    rotateToolBtn, yPos = createButton("Rotate Tool", yPos, Color3.fromRGB(100, 100, 100), function()
        local rotateTool = loadTool("RotateTool", ToolURLs.RotateTool)
        if not rotateTool then return end
        
        if rotateTool.IsEnabled() then
            rotateTool.Disable()
            rotateToolBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        else
            -- Disable other tools
            if LoadedTools.MoveTool and LoadedTools.MoveTool.IsEnabled() then
                LoadedTools.MoveTool.Disable()
                moveToolBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
            end
            
            rotateTool.Enable()
            rotateToolBtn.BackgroundColor3 = Color3.fromRGB(220, 100, 50)
        end
    end)
    
    -- Reset Rotation Button (Built-in)
    local resetBtn, yPos2 = createButton("Reset Rotation", yPos, Color3.fromRGB(80, 80, 80), function()
        -- Try to get selected parts from MoveTool or RotateTool
        local selectedConnectedParts = {}
        
        if LoadedTools.MoveTool and LoadedTools.MoveTool.GetSelectedConnectedParts then
            selectedConnectedParts = LoadedTools.MoveTool.GetSelectedConnectedParts()
        elseif LoadedTools.RotateTool and LoadedTools.RotateTool.GetSelectedConnectedParts then
            selectedConnectedParts = LoadedTools.RotateTool.GetSelectedConnectedParts()
        end
        
        if #selectedConnectedParts > 0 then
            for _, connectedPart in ipairs(selectedConnectedParts) do
                if connectedPart and connectedPart.Parent then
                    local bg = connectedPart:FindFirstChild("MoveToolGyro")
                    if bg and bg:IsA("BodyGyro") then
                        bg.CFrame = CFrame.new(connectedPart.Position)
                    end
                end
            end
            print("Rotation reset")
        else
            warn("No part selected")
        end
    end)
    yPos = yPos2
    
    -- Clear All Forces Button (Built-in)
    local clearBtn, yPos2 = createButton("Clear All Forces", yPos, Color3.fromRGB(60, 60, 60), function()
        for _, part in ipairs(game.Workspace:GetDescendants()) do
            if part:IsA("BasePart") then
                for _, child in ipairs(part:GetChildren()) do
                    if child.Name == "MoveToolPosition" or child.Name == "MoveToolGyro" or 
                       child.Name == "RingPosition" or child.Name == "RingGyro" or 
                       child.Name == "SpinVelocity" then
                        child:Destroy()
                    end
                end
            end
        end
        
        -- Disable all tools
        if LoadedTools.MoveTool then LoadedTools.MoveTool.Disable() end
        if LoadedTools.RotateTool then LoadedTools.RotateTool.Disable() end
        if LoadedTools.RingShape then LoadedTools.RingShape.Disable() end
        if LoadedTools.RPMTool then LoadedTools.RPMTool.Disable() end
        
        -- Reset button colors
        moveToolBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        rotateToolBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        if ringBtn then ringBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100) end
        if spinBtn then spinBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100) end
        
        print("All forces cleared")
    end)
    yPos = yPos2 + 20
    
    -- RING FORMATION Section
    local ringTitle = Instance.new("TextLabel")
    ringTitle.Size = UDim2.new(1, -20, 0, 30)
    ringTitle.Position = UDim2.new(0, 10, 0, yPos)
    ringTitle.BackgroundTransparency = 1
    ringTitle.Text = "RING FORMATION"
    ringTitle.Font = Enum.Font.GothamBlack
    ringTitle.TextSize = 16
    ringTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    ringTitle.TextXAlignment = Enum.TextXAlignment.Left
    ringTitle.Parent = miscContent
    yPos = yPos + 40
    
    ringBtn, yPos = createButton("Ring Shape", yPos, Color3.fromRGB(100, 100, 100), function()
        local ringShape = loadTool("RingShape", ToolURLs.RingShape)
        if not ringShape then return end
        
        if ringShape.IsEnabled() then
            ringShape.Disable()
            ringBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        else
            ringShape.Enable()
            ringBtn.BackgroundColor3 = Color3.fromRGB(138, 43, 226)
        end
    end)
    
    yPos = createSlider("Ring Radius", yPos, 5, 50, 10, function(value)
        local ringShape = LoadedTools.RingShape
        if ringShape then
            ringShape.SetRadius(value)
        end
    end)
    
    yPos = createSlider("Ring Height", yPos, -10, 20, 3, function(value)
        local ringShape = LoadedTools.RingShape
        if ringShape then
            ringShape.SetHeight(value)
        end
    end)
    
    yPos = createSlider("Ring Rotation", yPos, 0, 360, 0, function(value)
        local ringShape = LoadedTools.RingShape
        if ringShape then
            ringShape.SetRotation(value)
        end
    end)
    
    yPos = yPos + 20
    
    -- SPIN PARTS Section
    local spinTitle = Instance.new("TextLabel")
    spinTitle.Size = UDim2.new(1, -20, 0, 30)
    spinTitle.Position = UDim2.new(0, 10, 0, yPos)
    spinTitle.BackgroundTransparency = 1
    spinTitle.Text = "SPIN PARTS"
    spinTitle.Font = Enum.Font.GothamBlack
    spinTitle.TextSize = 16
    spinTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    spinTitle.TextXAlignment = Enum.TextXAlignment.Left
    spinTitle.Parent = miscContent
    yPos = yPos + 40
    
    spinBtn, yPos = createButton("Spin Parts", yPos, Color3.fromRGB(100, 100, 100), function()
        local rpmTool = loadTool("RPMTool", ToolURLs.RPMTool)
        if not rpmTool then return end
        
        if rpmTool.IsEnabled() then
            rpmTool.Disable()
            spinBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        else
            rpmTool.Enable()
            spinBtn.BackgroundColor3 = Color3.fromRGB(255, 100, 200)
        end
    end)
    
    yPos = createSlider("Spin RPM", yPos, 1, 3000, 10, function(value)
        local rpmTool = LoadedTools.RPMTool
        if rpmTool then
            rpmTool.SetRPM(value)
        end
    end)
    
    -- Spin Axis Selector
    local axisLabel = Instance.new("TextLabel")
    axisLabel.Size = UDim2.new(1, -20, 0, 25)
    axisLabel.Position = UDim2.new(0, 10, 0, yPos)
    axisLabel.BackgroundTransparency = 1
    axisLabel.Text = "Spin Axis:"
    axisLabel.Font = Enum.Font.GothamBold
    axisLabel.TextSize = 12
    axisLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    axisLabel.TextXAlignment = Enum.TextXAlignment.Left
    axisLabel.Parent = miscContent
    yPos = yPos + 30
    
    -- Vertical Button
    local verticalBtn = Instance.new("TextButton")
    verticalBtn.Size = UDim2.new(0, 135, 0, 30)
    verticalBtn.Position = UDim2.new(0, 10, 0, yPos)
    verticalBtn.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
    verticalBtn.BorderSizePixel = 0
    verticalBtn.Text = "Vertical"
    verticalBtn.Font = Enum.Font.GothamBold
    verticalBtn.TextSize = 12
    verticalBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    verticalBtn.Parent = miscContent
    
    -- Horizontal Button
    local horizontalBtn = Instance.new("TextButton")
    horizontalBtn.Size = UDim2.new(0, 135, 0, 30)
    horizontalBtn.Position = UDim2.new(0, 155, 0, yPos)
    horizontalBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    horizontalBtn.BorderSizePixel = 0
    horizontalBtn.Text = "Horizontal"
    horizontalBtn.Font = Enum.Font.GothamBold
    horizontalBtn.TextSize = 12
    horizontalBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    horizontalBtn.Parent = miscContent
    
    verticalBtn.MouseButton1Click:Connect(function()
        local rpmTool = LoadedTools.RPMTool
        if rpmTool then
            rpmTool.SetAxis("Vertical")
            verticalBtn.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
            horizontalBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        end
    end)
    
    horizontalBtn.MouseButton1Click:Connect(function()
        local rpmTool = LoadedTools.RPMTool
        if rpmTool then
            rpmTool.SetAxis("Horizontal")
            horizontalBtn.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
            verticalBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
        end
    end)
    
    yPos = yPos + 45
    
    -- SAFE-NOS Section
    local safeNosTitle = Instance.new("TextLabel")
    safeNosTitle.Size = UDim2.new(1, -20, 0, 30)
    safeNosTitle.Position = UDim2.new(0, 10, 0, yPos)
    safeNosTitle.BackgroundTransparency = 1
    safeNosTitle.Text = "SAFE-NOS"
    safeNosTitle.Font = Enum.Font.GothamBlack
    safeNosTitle.TextSize = 16
    safeNosTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    safeNosTitle.TextXAlignment = Enum.TextXAlignment.Left
    safeNosTitle.Parent = miscContent
    yPos = yPos + 40
    
    local safeNosBtn, newYPos = createButton("Safe-NOS", yPos, Color3.fromRGB(100, 100, 100), function()
        if getgenv().SafeNOSEnabled then
            getgenv().SafeNOSEnabled = false
            safeNosBtn.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
            safeNosBtn.Text = "Safe-NOS"
            
            if getgenv().SafeNOSConnection then
                getgenv().SafeNOSConnection:Disconnect()
                getgenv().SafeNOSConnection = nil
            end
        else
            getgenv().SafeNOSEnabled = true
            safeNosBtn.BackgroundColor3 = Color3.fromRGB(50, 255, 50)
            safeNosBtn.Text = "Safe-NOS (ON)"
            
            -- Start monitoring network ownership
            local Players = game:GetService("Players")
            local LocalPlayer = Players.LocalPlayer
            local RunService = game:GetService("RunService")
            
            getgenv().SafeNOSConnection = RunService.Heartbeat:Connect(function()
                if not getgenv().SafeNOSEnabled then return end
                
                for _, part in ipairs(workspace:GetDescendants()) do
                    if part:IsA("BasePart") then
                        -- Check for any forces
                        local hasForce = false
                        for _, child in ipairs(part:GetChildren()) do
                            if child.Name == "MoveToolPosition" or 
                               child.Name == "MoveToolGyro" or 
                               child.Name == "RingPosition" or 
                               child.Name == "RingGyro" or 
                               child.Name == "SpinVelocity" then
                                hasForce = true
                                
                                -- Check network ownership
                                local hasOwnership = part:CanSetNetworkOwnership()
                                if hasOwnership then
                                    local owner = part:GetNetworkOwner()
                                    -- If we don't own it (owner is not LocalPlayer), clear forces
                                    if owner ~= LocalPlayer then
                                        child:Destroy()
                                        print("Safe-NOS: Cleared force from " .. part.Name .. " (lost ownership)")
                                    end
                                end
                                
                                break
                            end
                        end
                    end
                end
            end)
        end
    end)
    yPos = newYPos
    
    local safeNosInfo = Instance.new("TextLabel")
    safeNosInfo.Size = UDim2.new(1, -20, 0, 40)
    safeNosInfo.Position = UDim2.new(0, 10, 0, yPos)
    safeNosInfo.BackgroundTransparency = 1
    safeNosInfo.Text = "Automatically removes forces when\nyou lose network ownership"
    safeNosInfo.Font = Enum.Font.Gotham
    safeNosInfo.TextSize = 11
    safeNosInfo.TextColor3 = Color3.fromRGB(200, 200, 200)
    safeNosInfo.TextXAlignment = Enum.TextXAlignment.Left
    safeNosInfo.TextYAlignment = Enum.TextYAlignment.Top
    safeNosInfo.TextWrapped = true
    safeNosInfo.Parent = miscContent
    yPos = yPos + 50
    
    miscContent.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

function MiscModule.Cleanup()
    -- Cleanup all loaded tools
    if LoadedTools.MoveTool then LoadedTools.MoveTool.Disable() end
    if LoadedTools.RotateTool then LoadedTools.RotateTool.Disable() end
    if LoadedTools.RingShape then LoadedTools.RingShape.Disable() end
    if LoadedTools.RPMTool then LoadedTools.RPMTool.Disable() end
    
    -- Cleanup Safe-NOS
    if getgenv().SafeNOSConnection then
        getgenv().SafeNOSConnection:Disconnect()
        getgenv().SafeNOSConnection = nil
    end
    getgenv().SafeNOSEnabled = false
end

return MiscModule
