-- Misc Module
-- F3X-style part controller

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

local MiscModule = {}

-- Settings
getgenv().MiscSettings = {
    PartControllerEnabled = false
}

-- Part controller variables
local selectedPart = nil
local isDragging = false
local dragAxis = nil -- "X", "Y", "Z", or nil for free drag
local dragStartMousePos = nil
local dragStartPartPos = nil
local selectionBox = nil
local dragHandles = nil
local dragConnection = nil

-- Create selection box and drag handles
local function createSelectionVisuals(part)
    -- Remove old visuals
    if selectionBox then
        selectionBox:Destroy()
    end
    if dragHandles then
        dragHandles:Destroy()
    end
    
    -- Create selection box
    selectionBox = Instance.new("SelectionBox")
    selectionBox.Color3 = Color3.fromRGB(0, 170, 255)
    selectionBox.LineThickness = 0.05
    selectionBox.Transparency = 0.3
    selectionBox.Adornee = part
    selectionBox.Parent = part
    
    -- Create drag handles (arrows)
    dragHandles = Instance.new("Handles")
    dragHandles.Adornee = part
    dragHandles.Color3 = Color3.fromRGB(255, 255, 255)
    dragHandles.Style = Enum.HandlesStyle.Movement
    dragHandles.Visible = true
    dragHandles.Parent = part
    
    return selectionBox, dragHandles
end

-- Get mouse target (unanchored parts only)
local function getMouseTarget()
    local mouse = LocalPlayer:GetMouse()
    local target = mouse.Target
    
    if target and target:IsA("BasePart") and not target.Anchored then
        -- Exclude character parts
        if not target:IsDescendantOf(LocalPlayer.Character) then
            return target
        end
    end
    
    return nil
end

-- Get mouse ray
local function getMouseRay()
    local camera = Workspace.CurrentCamera
    local mouse = LocalPlayer:GetMouse()
    return camera:ScreenPointToRay(mouse.X, mouse.Y)
end

-- Project point onto axis
local function projectOntoAxis(point, origin, axis)
    local offset = point - origin
    local projection = offset:Dot(axis)
    return origin + (axis * projection)
end

-- Drag part smoothly
local function dragPart()
    if not selectedPart or not selectedPart.Parent or not isDragging then
        return
    end
    
    local ray = getMouseRay()
    local camera = Workspace.CurrentCamera
    
    if dragAxis then
        -- Dragging on a specific axis
        local axis = Vector3.new(0, 0, 0)
        if dragAxis == "X" then
            axis = Vector3.new(1, 0, 0)
        elseif dragAxis == "Y" then
            axis = Vector3.new(0, 1, 0)
        elseif dragAxis == "Z" then
            axis = Vector3.new(0, 0, 1)
        end
        
        -- Find closest point on axis to mouse ray
        local partPos = selectedPart.Position
        local axisLine = partPos + axis
        
        -- Calculate intersection
        local cameraCFrame = camera.CFrame
        local mouseDir = ray.Direction
        
        -- Project mouse ray onto the axis
        local t = ((dragStartPartPos - cameraCFrame.Position):Dot(axis)) / (mouseDir:Dot(axis))
        local mousePoint = cameraCFrame.Position + (mouseDir * t)
        
        -- Project onto axis
        local targetPos = projectOntoAxis(mousePoint, dragStartPartPos, axis)
        
        -- Smooth movement
        local currentPos = selectedPart.Position
        local newPos = currentPos:Lerp(targetPos, 0.5)
        
        selectedPart.CFrame = CFrame.new(newPos) * (selectedPart.CFrame - selectedPart.CFrame.Position)
    else
        -- Free drag on plane perpendicular to camera
        local planeNormal = camera.CFrame.LookVector
        local planePosition = selectedPart.Position
        
        -- Ray-plane intersection
        local denominator = ray.Direction:Dot(planeNormal)
        
        if math.abs(denominator) > 0.0001 then
            local t = (planePosition - ray.Origin):Dot(planeNormal) / denominator
            local mousePos3D = ray.Origin + ray.Direction * t
            
            -- Calculate offset
            local offset = mousePos3D - dragStartMousePos
            local targetPos = dragStartPartPos + offset
            
            -- Smooth movement
            local currentPos = selectedPart.Position
            local newPos = currentPos:Lerp(targetPos, 0.5)
            
            selectedPart.CFrame = CFrame.new(newPos) * (selectedPart.CFrame - selectedPart.CFrame.Position)
        end
    end
    
    -- Reset velocity for smooth control
    selectedPart.AssemblyLinearVelocity = Vector3.new(0, 0, 0)
    selectedPart.AssemblyAngularVelocity = Vector3.new(0, 0, 0)
end

-- Start part controller
local function startPartController()
    if dragConnection then return end
    
    print("Part Controller enabled")
    print("Click part to select | Drag arrows to move on axis | T to anchor/unanchor")
    
    -- Mouse click - select part
    local mouse = LocalPlayer:GetMouse()
    mouse.Button1Down:Connect(function()
        if not getgenv().MiscSettings.PartControllerEnabled then return end
        if isDragging then return end -- Don't select while dragging
        
        local target = getMouseTarget()
        if target then
            selectedPart = target
            createSelectionVisuals(selectedPart)
            print("Selected:", selectedPart.Name)
            
            -- Connect handle events
            if dragHandles then
                dragHandles.MouseButton1Down:Connect(function(face)
                    isDragging = true
                    
                    -- Determine axis from face
                    if face == Enum.NormalId.Right or face == Enum.NormalId.Left then
                        dragAxis = "X"
                    elseif face == Enum.NormalId.Top or face == Enum.NormalId.Bottom then
                        dragAxis = "Y"
                    elseif face == Enum.NormalId.Front or face == Enum.NormalId.Back then
                        dragAxis = "Z"
                    end
                    
                    dragStartPartPos = selectedPart.Position
                    
                    local ray = getMouseRay()
                    local camera = Workspace.CurrentCamera
                    local planeNormal = camera.CFrame.LookVector
                    local planePosition = selectedPart.Position
                    local denominator = ray.Direction:Dot(planeNormal)
                    
                    if math.abs(denominator) > 0.0001 then
                        local t = (planePosition - ray.Origin):Dot(planeNormal) / denominator
                        dragStartMousePos = ray.Origin + ray.Direction * t
                    end
                    
                    print("Dragging on axis:", dragAxis)
                end)
                
                dragHandles.MouseButton1Up:Connect(function()
                    if isDragging then
                        isDragging = false
                        dragAxis = nil
                        print("Drag released")
                    end
                end)
            end
        end
    end)
    
    -- T key - Toggle anchor
    UserInputService.InputBegan:Connect(function(input, gameProcessed)
        if gameProcessed then return end
        if not getgenv().MiscSettings.PartControllerEnabled then return end
        
        if input.KeyCode == Enum.KeyCode.T and selectedPart then
            selectedPart.Anchored = not selectedPart.Anchored
            print(selectedPart.Name, selectedPart.Anchored and "ANCHORED" or "UNANCHORED")
            
            -- Update visual color
            if selectionBox then
                selectionBox.Color3 = selectedPart.Anchored and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(0, 170, 255)
            end
            
            -- Remove selection if now anchored
            if selectedPart.Anchored then
                if dragHandles then
                    dragHandles:Destroy()
                    dragHandles = nil
                end
            else
                -- Recreate handles if unanchored
                createSelectionVisuals(selectedPart)
            end
        elseif input.KeyCode == Enum.KeyCode.Escape and selectedPart then
            print("Deselected:", selectedPart.Name)
            selectedPart = nil
            isDragging = false
            dragAxis = nil
            if selectionBox then
                selectionBox:Destroy()
                selectionBox = nil
            end
            if dragHandles then
                dragHandles:Destroy()
                dragHandles = nil
            end
        end
    end)
    
    -- Drag loop (smooth real-time movement)
    dragConnection = RunService.RenderStepped:Connect(function()
        if getgenv().MiscSettings.PartControllerEnabled and isDragging then
            pcall(dragPart)
        end
    end)
end

local function stopPartController()
    if dragConnection then
        dragConnection:Disconnect()
        dragConnection = nil
    end
    
    if selectionBox then
        selectionBox:Destroy()
        selectionBox = nil
    end
    
    if dragHandles then
        dragHandles:Destroy()
        dragHandles = nil
    end
    
    selectedPart = nil
    isDragging = false
    dragAxis = nil
    print("Part Controller disabled")
end

function MiscModule.CreateUI(parent)
    local miscContent = Instance.new("ScrollingFrame")
    miscContent.Size = UDim2.new(1, 0, 1, 0)
    miscContent.BackgroundTransparency = 1
    miscContent.BorderSizePixel = 0
    miscContent.ScrollBarThickness = 4
    miscContent.Parent = parent
    
    local yPos = 10
    
    -- Helper function to create toggle button
    local function createToggleButton(name, settingsTable, settingKey, position, callback)
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, -20, 0, 35)
        button.Position = UDim2.new(0, 10, 0, position)
        button.BackgroundColor3 = settingsTable[settingKey] and Color3.fromRGB(30, 144, 255) or Color3.fromRGB(60, 60, 60)
        button.BorderSizePixel = 0
        button.Text = name .. ": " .. (settingsTable[settingKey] and "ENABLED" or "DISABLED")
        button.Font = Enum.Font.GothamBold
        button.TextSize = 14
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.Parent = miscContent
        
        button.MouseButton1Click:Connect(function()
            settingsTable[settingKey] = not settingsTable[settingKey]
            button.BackgroundColor3 = settingsTable[settingKey] and Color3.fromRGB(30, 144, 255) or Color3.fromRGB(60, 60, 60)
            button.Text = name .. ": " .. (settingsTable[settingKey] and "ENABLED" or "DISABLED")
            if callback then callback(settingsTable[settingKey]) end
        end)
        
        return position + 45
    end
    
    -- PART CONTROLLER Section
    local controllerTitle = Instance.new("TextLabel")
    controllerTitle.Size = UDim2.new(1, -20, 0, 30)
    controllerTitle.Position = UDim2.new(0, 10, 0, yPos)
    controllerTitle.BackgroundTransparency = 1
    controllerTitle.Text = "PART CONTROLLER"
    controllerTitle.Font = Enum.Font.GothamBlack
    controllerTitle.TextSize = 16
    controllerTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    controllerTitle.TextXAlignment = Enum.TextXAlignment.Left
    controllerTitle.Parent = miscContent
    yPos = yPos + 40
    
    yPos = createToggleButton("Part Controller", getgenv().MiscSettings, "PartControllerEnabled", yPos, function(enabled)
        if enabled then
            startPartController()
        else
            stopPartController()
        end
    end)
    
    -- Controls info
    local controlsTitle = Instance.new("TextLabel")
    controlsTitle.Size = UDim2.new(1, -20, 0, 25)
    controlsTitle.Position = UDim2.new(0, 10, 0, yPos)
    controlsTitle.BackgroundTransparency = 1
    controlsTitle.Text = "HOW TO USE:"
    controlsTitle.Font = Enum.Font.GothamBold
    controlsTitle.TextSize = 12
    controlsTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    controlsTitle.TextXAlignment = Enum.TextXAlignment.Left
    controlsTitle.Parent = miscContent
    yPos = yPos + 30
    
    local controlsInfo = Instance.new("TextLabel")
    controlsInfo.Size = UDim2.new(1, -20, 0, 130)
    controlsInfo.Position = UDim2.new(0, 10, 0, yPos)
    controlsInfo.BackgroundTransparency = 1
    controlsInfo.Text = [[1. Click on any unanchored part to select
2. Drag the colored arrows to move on that axis
   • Red arrow = X axis
   • Green arrow = Y axis  
   • Blue arrow = Z axis
3. Movement is smooth and visible to others
4. Press T to anchor/unanchor the part
5. Press Escape to deselect

Works like Roblox Studio's Move tool!]]
    controlsInfo.Font = Enum.Font.Gotham
    controlsInfo.TextSize = 11
    controlsInfo.TextColor3 = Color3.fromRGB(200, 200, 200)
    controlsInfo.TextXAlignment = Enum.TextXAlignment.Left
    controlsInfo.TextYAlignment = Enum.TextYAlignment.Top
    controlsInfo.TextWrapped = true
    controlsInfo.Parent = miscContent
    yPos = yPos + 140
    
    miscContent.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

function MiscModule.Cleanup()
    stopPartController()
end

return MiscModule
