-- Part Controller Script
-- Move Tool, Rotate Tool, Reset Rotation
-- Method-based control

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local CoreGui = game:GetService("CoreGui")

local LocalPlayer = Players.LocalPlayer
local mouse = LocalPlayer:GetMouse()

-- Part Controller Variables
local moveToolEnabled = false
local selectedPart = nil
local selectionBox = nil
local handles = nil
local arcHandles = nil
local selectedConnectedParts = {}
local moveMode = "move" -- "move" or "rotate"

-- Helper Functions
local function isBodyPart(part)
    local bodyPartNames = {"Torso", "Head", "Right Arm", "Left Arm", "Right Leg", "Left Leg", "HumanoidRootPart", 
                           "UpperTorso", "LowerTorso", "LeftUpperArm", "RightUpperArm", "LeftLowerArm", "RightLowerArm",
                           "LeftUpperLeg", "RightUpperLeg", "LeftLowerLeg", "RightLowerLeg", "LeftHand", "RightHand",
                           "LeftFoot", "RightFoot"}
    return table.find(bodyPartNames, part.Name) ~= nil
end

local function getConnectedParts(part)
    local connectedParts = {part}
    local checkedParts = {}
    local partsToCheck = {part}
    
    while #partsToCheck > 0 do
        local currentPart = table.remove(partsToCheck, 1)
        if not checkedParts[currentPart] then
            checkedParts[currentPart] = true
            
            for _, child in ipairs(currentPart:GetChildren()) do
                if child:IsA("Weld") or child:IsA("WeldConstraint") or child:IsA("Motor6D") or child:IsA("ManualWeld") then
                    local connectedPart = child.Part0 == currentPart and child.Part1 or child.Part0
                    if connectedPart and not checkedParts[connectedPart] then
                        table.insert(connectedParts, connectedPart)
                        table.insert(partsToCheck, connectedPart)
                    end
                end
            end
            
            -- Check for joints
            for _, joint in ipairs(currentPart:GetJoints()) do
                local connectedPart = joint.Part0 == currentPart and joint.Part1 or joint.Part0
                if connectedPart and not checkedParts[connectedPart] then
                    table.insert(connectedParts, connectedPart)
                    table.insert(partsToCheck, connectedPart)
                end
            end
        end
    end
    
    return connectedParts
end

local function createSelectionBox(part)
    if selectionBox then
        selectionBox:Destroy()
    end
    if handles then
        handles:Destroy()
    end
    if arcHandles then
        arcHandles:Destroy()
    end
    
    selectedConnectedParts = getConnectedParts(part)
    
    selectionBox = Instance.new("SelectionBox")
    selectionBox.Adornee = part
    selectionBox.Color3 = Color3.fromRGB(0, 170, 255)
    selectionBox.LineThickness = 0.05
    selectionBox.Parent = part
    
    if moveMode == "move" then
        -- Create Movement Handles
        handles = Instance.new("Handles")
        handles.Adornee = part
        handles.Color3 = Color3.fromRGB(0, 170, 255)
        handles.Style = Enum.HandlesStyle.Movement
        handles.Parent = LocalPlayer.PlayerGui
        
        handles.MouseDrag:Connect(function(face, distance)
            if not selectedPart or not selectedPart.Parent then return end
            
            local moveVector = Vector3.new()
            local adjustedDistance = distance * 0.5
            
            if face == Enum.NormalId.Top then
                moveVector = Vector3.new(0, adjustedDistance, 0)
            elseif face == Enum.NormalId.Bottom then
                moveVector = Vector3.new(0, -adjustedDistance, 0)
            elseif face == Enum.NormalId.Right then
                moveVector = Vector3.new(adjustedDistance, 0, 0)
            elseif face == Enum.NormalId.Left then
                moveVector = Vector3.new(-adjustedDistance, 0, 0)
            elseif face == Enum.NormalId.Front then
                moveVector = Vector3.new(0, 0, -adjustedDistance)
            elseif face == Enum.NormalId.Back then
                moveVector = Vector3.new(0, 0, adjustedDistance)
            end
            
            for _, connectedPart in ipairs(selectedConnectedParts) do
                if connectedPart and connectedPart.Parent then
                    local bp = connectedPart:FindFirstChild("MoveToolPosition")
                    if bp then
                        bp.Position = bp.Position + moveVector
                    end
                end
            end
        end)
    elseif moveMode == "rotate" then
        -- Create Rotation Handles
        arcHandles = Instance.new("ArcHandles")
        arcHandles.Adornee = part
        arcHandles.Color3 = Color3.fromRGB(255, 100, 100)
        arcHandles.Parent = LocalPlayer.PlayerGui
        
        arcHandles.MouseDrag:Connect(function(axis, relativeAngle)
            if not selectedPart or not selectedPart.Parent then return end
            
            local rotationCFrame = CFrame.new()
            if axis == Enum.Axis.X then
                rotationCFrame = CFrame.Angles(relativeAngle, 0, 0)
            elseif axis == Enum.Axis.Y then
                rotationCFrame = CFrame.Angles(0, relativeAngle, 0)
            elseif axis == Enum.Axis.Z then
                rotationCFrame = CFrame.Angles(0, 0, relativeAngle)
            end
            
            local centerPos = selectedPart.Position
            for _, connectedPart in ipairs(selectedConnectedParts) do
                if connectedPart and connectedPart.Parent then
                    local bg = connectedPart:FindFirstChild("MoveToolGyro")
                    if bg then
                        local offset = connectedPart.Position - centerPos
                        local rotatedOffset = rotationCFrame:VectorToWorldSpace(offset)
                        
                        local bp = connectedPart:FindFirstChild("MoveToolPosition")
                        if bp then
                            bp.Position = centerPos + rotatedOffset
                        end
                        
                        bg.CFrame = bg.CFrame * rotationCFrame
                    end
                end
            end
        end)
    end
    
    -- Apply BodyPosition and BodyGyro to all connected parts
    for _, connectedPart in ipairs(selectedConnectedParts) do
        if connectedPart and connectedPart.Parent then
            local bp = Instance.new("BodyPosition")
            bp.Name = "MoveToolPosition"
            bp.MaxForce = Vector3.new(math.huge, math.huge, math.huge)
            bp.Position = connectedPart.Position
            bp.P = 100000
            bp.D = 5000
            bp.Parent = connectedPart
            
            local bg = Instance.new("BodyGyro")
            bg.Name = "MoveToolGyro"
            bg.MaxTorque = Vector3.new(math.huge, math.huge, math.huge)
            bg.CFrame = connectedPart.CFrame
            bg.P = 100000
            bg.D = 5000
            bg.Parent = connectedPart
        end
    end
end

local function removeSelectionBox()
    for _, connectedPart in ipairs(selectedConnectedParts) do
        if connectedPart and connectedPart.Parent then
            local bp = connectedPart:FindFirstChild("MoveToolPosition")
            if bp then bp:Destroy() end
            
            local bg = connectedPart:FindFirstChild("MoveToolGyro")
            if bg then bg:Destroy() end
        end
    end
    
    selectedConnectedParts = {}
    
    if selectionBox then
        selectionBox:Destroy()
        selectionBox = nil
    end
    
    if handles then
        handles:Destroy()
        handles = nil
    end
    
    if arcHandles then
        arcHandles:Destroy()
        arcHandles = nil
    end
end

-- Clear all forces in workspace
local function clearAllForces()
    for _, part in ipairs(workspace:GetDescendants()) do
        if part:IsA("BasePart") then
            for _, child in ipairs(part:GetChildren()) do
                if child.Name == "MoveToolPosition" or child.Name == "MoveToolGyro" then
                    child:Destroy()
                end
            end
        end
    end
    
    removeSelectionBox()
    selectedPart = nil
    
    print("All forces cleared")
end

-- Exported Methods
getgenv().PartController = {
    -- Enable move tool
    EnableMoveTool = function()
        if moveToolEnabled and moveMode == "move" then
            print("Move tool already enabled")
            return
        end
        
        moveToolEnabled = true
        moveMode = "move"
        
        if selectedPart and selectedPart.Parent then
            createSelectionBox(selectedPart)
        end
        
        print("Move tool enabled - Click parts to select and drag arrows to move")
    end,
    
    -- Enable rotate tool
    EnableRotateTool = function()
        if moveToolEnabled and moveMode == "rotate" then
            print("Rotate tool already enabled")
            return
        end
        
        moveToolEnabled = true
        moveMode = "rotate"
        
        if selectedPart and selectedPart.Parent then
            createSelectionBox(selectedPart)
        end
        
        print("Rotate tool enabled - Click parts to select and drag circles to rotate")
    end,
    
    -- Disable tools
    DisableTools = function()
        moveToolEnabled = false
        removeSelectionBox()
        selectedPart = nil
        print("Tools disabled")
    end,
    
    -- Reset rotation of selected part
    ResetRotation = function()
        if not selectedPart or not selectedPart.Parent then
            warn("No part selected")
            return
        end
        
        for _, connectedPart in ipairs(selectedConnectedParts) do
            if connectedPart and connectedPart.Parent then
                local bg = connectedPart:FindFirstChild("MoveToolGyro")
                if bg then
                    bg.CFrame = CFrame.new(connectedPart.Position)
                end
            end
        end
        
        print("Rotation reset for", selectedPart.Name)
    end,
    
    -- Clear all forces
    ClearAllForces = function()
        clearAllForces()
    end,
    
    -- Deselect current part
    DeselectPart = function()
        removeSelectionBox()
        selectedPart = nil
        print("Part deselected")
    end,
    
    -- Get selected part
    GetSelectedPart = function()
        return selectedPart
    end,
    
    -- Check if tools are enabled
    IsEnabled = function()
        return moveToolEnabled
    end,
    
    -- Get current mode
    GetMode = function()
        return moveMode
    end
}

-- Mouse Click Handler
mouse.Button1Down:Connect(function()
    if not moveToolEnabled then return end
    
    local target = mouse.Target
    if target and (target:IsA("BasePart") or target:IsA("UnionOperation")) then
        -- Check if it's not a character part
        local isPlayerPart = false
        for _, plr in ipairs(Players:GetPlayers()) do
            if plr.Character and target:IsDescendantOf(plr.Character) then
                isPlayerPart = true
                break
            end
        end
        
        if not target.Anchored and not isPlayerPart and not isBodyPart(target) then
            selectedPart = target
            createSelectionBox(target)
            print("Selected:", target.Name, "| Connected parts:", #selectedConnectedParts)
        end
    end
end)

-- Keyboard Handler
UserInputService.InputBegan:Connect(function(input, gameProcessed)
    if gameProcessed then return end
    
    if moveToolEnabled and selectedPart then
        if input.KeyCode == Enum.KeyCode.Delete and selectedPart.Parent then
            print("Deleting:", selectedPart.Name)
            selectedPart:Destroy()
            removeSelectionBox()
            selectedPart = nil
        elseif input.KeyCode == Enum.KeyCode.Escape then
            removeSelectionBox()
            selectedPart = nil
            print("Part deselected")
        elseif input.KeyCode == Enum.KeyCode.T then
            selectedPart.Anchored = not selectedPart.Anchored
            print(selectedPart.Name, selectedPart.Anchored and "ANCHORED" or "UNANCHORED")
            if selectedPart.Anchored then
                removeSelectionBox()
                selectedPart = nil
            end
        end
    end
end)

print("Part Controller loaded!")
print("")
print("=== METHODS ===")
print("PartController.EnableMoveTool() - Enable move tool")
print("PartController.EnableRotateTool() - Enable rotate tool")
print("PartController.DisableTools() - Disable tools")
print("PartController.ResetRotation() - Reset rotation of selected part")
print("PartController.ClearAllForces() - Clear all forces in workspace")
print("PartController.DeselectPart() - Deselect current part")
print("PartController.GetSelectedPart() - Get selected part")
print("PartController.IsEnabled() - Check if tools are enabled")
print("PartController.GetMode() - Get current mode ('move' or 'rotate')")
print("")
print("=== CONTROLS ===")
print("Left Click - Select unanchored part")
print("Drag Arrows - Move part (Move Tool)")
print("Drag Circles - Rotate part (Rotate Tool)")
print("T Key - Toggle anchor/unanchor")
print("Delete Key - Delete selected part")
print("Escape - Deselect part")
