-- Combat Module - Main GUI
-- Loads Hitbox and Aimlock scripts from GitHub

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")

local CombatModule = {}

-- GitHub URLs
local HITBOX_URL = "https://raw.githubusercontent.com/givenship/Unanchor.euva/refs/heads/main/Hitbox"
local AIMLOCK_URL = "https://raw.githubusercontent.com/givenship/Unanchor.euva/refs/heads/main/Aimlock"
local AUTODEFUSE_URL = "https://raw.githubusercontent.com/givenship/Unanchor.euva/refs/heads/main/Auto.defuse"

-- Settings for Hitbox
getgenv().HitboxSettings = {
    Enabled = false,
    UsePositionOffset = false, -- Alternative mode (not recommended)
    HitboxLeft = 0,
    HitboxRight = 0,
    HitboxUp = 0,
    HitboxDown = 0,
    HitboxFront = 0,
    HitboxBack = 0,
    HitboxPosX = 0,
    HitboxPosY = 0,
    HitboxPosZ = 0,
    HitboxTransparency = 0.5,
    PreviewTransparency = 0.7,
    TeamCheck = false,
    VisibilityCheck = false
}

-- Settings for Aimlock
getgenv().AimlockSettings = {
    Enabled = false,
    Smoothness = 1,
    ShowFOV = false,
    FOVSize = 100,
    TeamCheck = false,
    VisibilityCheck = false
}

-- Settings for Auto Defuse
getgenv().AutoDefuseSettings = {
    Enabled = false
}

local hitboxLoaded = false
local aimlockLoaded = false
local autoDefuseLoaded = false

local function loadScript(url)
    print("Attempting to load from: " .. url)
    
    local success, result = pcall(function()
        return game:HttpGet(url)
    end)
    
    if not success then
        warn("HTTP GET failed: " .. tostring(result))
        return false
    end
    
    if not result or result == "" then
        warn("Empty response from GitHub")
        return false
    end
    
    print("Script downloaded, size: " .. #result .. " bytes")
    
    local loadSuccess, loadResult = pcall(function()
        return loadstring(result)()
    end)
    
    if not loadSuccess then
        warn("loadstring failed: " .. tostring(loadResult))
        return false
    end
    
    return true
end

function CombatModule.CreateUI(parent)
    local combatContent = Instance.new("ScrollingFrame")
    combatContent.Name = "CombatContent"
    combatContent.Size = UDim2.new(1, -20, 1, -20)
    combatContent.Position = UDim2.new(0, 10, 0, 10)
    combatContent.BackgroundTransparency = 1
    combatContent.BorderSizePixel = 0
    combatContent.ScrollBarThickness = 4
    combatContent.ScrollBarImageColor3 = Color3.fromRGB(255, 255, 255)
    combatContent.Parent = parent
    
    local yPos = 10
    
    -- Hitbox Section
    local hitboxTitle = Instance.new("TextLabel")
    hitboxTitle.Size = UDim2.new(1, -20, 0, 30)
    hitboxTitle.Position = UDim2.new(0, 10, 0, yPos)
    hitboxTitle.BackgroundTransparency = 1
    hitboxTitle.Text = "HITBOX ADJUSTMENT"
    hitboxTitle.Font = Enum.Font.GothamBlack
    hitboxTitle.TextSize = 16
    hitboxTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    hitboxTitle.TextXAlignment = Enum.TextXAlignment.Left
    hitboxTitle.Parent = combatContent
    yPos = yPos + 40
    
    local function createToggleButton(name, settingsTable, settingKey, position, callback)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 50)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = combatContent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0.4, -10, 0, 40)
        label.Position = UDim2.new(0, 0, 0, 5)
        label.BackgroundTransparency = 1
        label.Text = name
        label.Font = Enum.Font.GothamBold
        label.TextSize = 14
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        local toggleButton = Instance.new("TextButton")
        toggleButton.Size = UDim2.new(0, 140, 0, 40)
        toggleButton.Position = UDim2.new(1, -140, 0, 5)
        toggleButton.BackgroundColor3 = Color3.fromRGB(180, 30, 30)
        toggleButton.BorderSizePixel = 0
        toggleButton.Text = "DISABLED"
        toggleButton.Font = Enum.Font.GothamBlack
        toggleButton.TextSize = 14
        toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
        toggleButton.AutoButtonColor = false
        toggleButton.Parent = container
        
        toggleButton.MouseButton1Click:Connect(function()
            settingsTable[settingKey] = not settingsTable[settingKey]
            
            if settingsTable[settingKey] then
                toggleButton.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
                toggleButton.Text = "ENABLED"
            else
                toggleButton.BackgroundColor3 = Color3.fromRGB(180, 30, 30)
                toggleButton.Text = "DISABLED"
            end
            
            if callback then callback(settingsTable[settingKey]) end
        end)
        
        return position + 60
    end
    
    local function createSlider(name, settingsTable, settingKey, minVal, maxVal, position)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 50)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = combatContent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0, 100, 0, 20)
        label.Position = UDim2.new(0, 0, 0, 5)
        label.BackgroundTransparency = 1
        label.Text = name .. ": " .. settingsTable[settingKey]
        label.Font = Enum.Font.GothamBold
        label.TextSize = 12
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        local sliderBg = Instance.new("Frame")
        sliderBg.Size = UDim2.new(1, -110, 0, 20)
        sliderBg.Position = UDim2.new(0, 105, 0, 25)
        sliderBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        sliderBg.BorderSizePixel = 1
        sliderBg.BorderColor3 = Color3.fromRGB(255, 255, 255)
        sliderBg.Parent = container
        
        local sliderFill = Instance.new("Frame")
        sliderFill.Size = UDim2.new((settingsTable[settingKey] - minVal) / (maxVal - minVal), 0, 1, 0)
        sliderFill.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
        sliderFill.BorderSizePixel = 0
        sliderFill.Parent = sliderBg
        
        local sliderButton = Instance.new("TextButton")
        sliderButton.Size = UDim2.new(1, 0, 1, 0)
        sliderButton.BackgroundTransparency = 1
        sliderButton.Text = ""
        sliderButton.Parent = sliderBg
        
        local dragging = false
        
        sliderButton.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        RunService.RenderStepped:Connect(function()
            if dragging then
                local mouse = UserInputService:GetMouseLocation()
                local relativeX = math.clamp(mouse.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
                local percentage = relativeX / sliderBg.AbsoluteSize.X
                local value = math.floor(minVal + (maxVal - minVal) * percentage)
                
                settingsTable[settingKey] = value
                sliderFill.Size = UDim2.new(percentage, 0, 1, 0)
                label.Text = name .. ": " .. value
            end
        end)
        
        return position + 60
    end
    
    local function createTransparencySlider(name, settingsTable, settingKey, position)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 50)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = combatContent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0, 120, 0, 20)
        label.Position = UDim2.new(0, 0, 0, 5)
        label.BackgroundTransparency = 1
        label.Text = name .. ": " .. string.format("%.2f", settingsTable[settingKey])
        label.Font = Enum.Font.GothamBold
        label.TextSize = 12
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        local sliderBg = Instance.new("Frame")
        sliderBg.Size = UDim2.new(1, -130, 0, 20)
        sliderBg.Position = UDim2.new(0, 125, 0, 25)
        sliderBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        sliderBg.BorderSizePixel = 1
        sliderBg.BorderColor3 = Color3.fromRGB(255, 255, 255)
        sliderBg.Parent = container
        
        local sliderFill = Instance.new("Frame")
        sliderFill.Size = UDim2.new(settingsTable[settingKey], 0, 1, 0)
        sliderFill.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
        sliderFill.BorderSizePixel = 0
        sliderFill.Parent = sliderBg
        
        local sliderButton = Instance.new("TextButton")
        sliderButton.Size = UDim2.new(1, 0, 1, 0)
        sliderButton.BackgroundTransparency = 1
        sliderButton.Text = ""
        sliderButton.Parent = sliderBg
        
        local dragging = false
        
        sliderButton.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        RunService.RenderStepped:Connect(function()
            if dragging then
                local mouse = UserInputService:GetMouseLocation()
                local relativeX = math.clamp(mouse.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
                local percentage = relativeX / sliderBg.AbsoluteSize.X
                local value = percentage
                
                settingsTable[settingKey] = value
                sliderFill.Size = UDim2.new(percentage, 0, 1, 0)
                label.Text = name .. ": " .. string.format("%.2f", value)
            end
        end)
        
        return position + 60
    end
    
    local function createCheckbox(name, settingsTable, settingKey, position)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 30)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = combatContent
        
        local checkbox = Instance.new("TextButton")
        checkbox.Size = UDim2.new(0, 20, 0, 20)
        checkbox.Position = UDim2.new(0, 0, 0, 5)
        checkbox.BackgroundColor3 = Color3.fromRGB(124, 124, 124)
        checkbox.BackgroundTransparency = 0.3
        checkbox.BorderSizePixel = 1
        checkbox.BorderColor3 = Color3.fromRGB(255, 255, 255)
        checkbox.Text = ""
        checkbox.AutoButtonColor = false
        checkbox.Parent = container
        
        local checkmark = Instance.new("TextLabel")
        checkmark.Size = UDim2.new(1, 0, 1, 0)
        checkmark.BackgroundTransparency = 1
        checkmark.Text = ""
        checkmark.Font = Enum.Font.GothamBlack
        checkmark.TextSize = 16
        checkmark.TextColor3 = Color3.fromRGB(255, 255, 255)
        checkmark.Parent = checkbox
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, -30, 0, 30)
        label.Position = UDim2.new(0, 30, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = name
        label.Font = Enum.Font.GothamBold
        label.TextSize = 14
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        checkbox.MouseButton1Click:Connect(function()
            settingsTable[settingKey] = not settingsTable[settingKey]
            checkmark.Text = settingsTable[settingKey] and "✓" or ""
        end)
        
        return position + 40
    end
    
    -- Hitbox controls
    yPos = createToggleButton("Hitbox", getgenv().HitboxSettings, "Enabled", yPos, function(enabled)
        if not hitboxLoaded then
            print("Loading Hitbox script from GitHub...")
            hitboxLoaded = loadScript(HITBOX_URL)
            if not hitboxLoaded then
                warn("Failed to load Hitbox script from GitHub")
                warn("URL: " .. HITBOX_URL)
                getgenv().HitboxSettings.Enabled = false
                return
            end
            print("Hitbox script loaded successfully!")
        end
        
        if not getgenv().HitboxControl then
            warn("HitboxControl not found after loading")
            getgenv().HitboxSettings.Enabled = false
            return
        end
        
        if enabled then
            getgenv().HitboxControl.Start()
        else
            getgenv().HitboxControl.Stop()
        end
    end)
    
    -- Hitbox directional controls with separate sliders
    local function createDirectionalControl(name, directions, position)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 100)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = combatContent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(1, 0, 0, 20)
        label.Position = UDim2.new(0, 0, 0, 0)
        label.BackgroundTransparency = 1
        label.Text = name
        label.Font = Enum.Font.GothamBlack
        label.TextSize = 14
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        for i, dir in ipairs(directions) do
            -- Direction label and slider
            local sliderContainer = Instance.new("Frame")
            sliderContainer.Size = UDim2.new(1, -40, 0, 30)
            sliderContainer.Position = UDim2.new(0, 35, 0, 20 + (i - 1) * 35)
            sliderContainer.BackgroundTransparency = 1
            sliderContainer.Parent = container
            
            -- Direction button (now just a label)
            local dirButton = Instance.new("TextLabel")
            dirButton.Size = UDim2.new(0, 25, 0, 20)
            dirButton.Position = UDim2.new(0, -35, 0, 5)
            dirButton.BackgroundColor3 = Color3.fromRGB(60, 60, 60)
            dirButton.BorderSizePixel = 1
            dirButton.BorderColor3 = Color3.fromRGB(255, 255, 255)
            dirButton.Text = dir.label
            dirButton.Font = Enum.Font.GothamBlack
            dirButton.TextSize = 14
            dirButton.TextColor3 = Color3.fromRGB(255, 255, 255)
            dirButton.Parent = sliderContainer
            
            local valueLabel = Instance.new("TextLabel")
            valueLabel.Size = UDim2.new(0, 30, 0, 20)
            valueLabel.Position = UDim2.new(0, 0, 0, 5)
            valueLabel.BackgroundTransparency = 1
            valueLabel.Text = tostring(getgenv().HitboxSettings[dir.key] or 0)
            valueLabel.Font = Enum.Font.GothamBold
            valueLabel.TextSize = 12
            valueLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            valueLabel.TextXAlignment = Enum.TextXAlignment.Right
            valueLabel.Parent = sliderContainer
            
            local sliderBg = Instance.new("Frame")
            sliderBg.Size = UDim2.new(1, -35, 0, 20)
            sliderBg.Position = UDim2.new(0, 35, 0, 5)
            sliderBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
            sliderBg.BorderSizePixel = 1
            sliderBg.BorderColor3 = Color3.fromRGB(255, 255, 255)
            sliderBg.Parent = sliderContainer
            
            local sliderFill = Instance.new("Frame")
            sliderFill.Size = UDim2.new((getgenv().HitboxSettings[dir.key] or 0) / 20, 0, 1, 0)
            sliderFill.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
            sliderFill.BorderSizePixel = 0
            sliderFill.Parent = sliderBg
            
            local sliderButton = Instance.new("TextButton")
            sliderButton.Size = UDim2.new(1, 0, 1, 0)
            sliderButton.BackgroundTransparency = 1
            sliderButton.Text = ""
            sliderButton.Parent = sliderBg
            
            -- Slider dragging
            local dragging = false
            
            sliderButton.MouseButton1Down:Connect(function()
                dragging = true
            end)
            
            UserInputService.InputEnded:Connect(function(input)
                if input.UserInputType == Enum.UserInputType.MouseButton1 then
                    dragging = false
                end
            end)
            
            RunService.RenderStepped:Connect(function()
                if dragging then
                    local mouse = UserInputService:GetMouseLocation()
                    local relativeX = math.clamp(mouse.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
                    local percentage = relativeX / sliderBg.AbsoluteSize.X
                    local value = math.floor(0 + (20 - 0) * percentage)
                    
                    getgenv().HitboxSettings[dir.key] = value
                    sliderFill.Size = UDim2.new(value / 20, 0, 1, 0)
                    valueLabel.Text = tostring(value)
                end
            end)
        end
        
        return position + 110
    end
    
    yPos = createDirectionalControl("Hitbox X", {
        {label = "L", key = "HitboxLeft"},
        {label = "R", key = "HitboxRight"}
    }, yPos)
    
    yPos = createDirectionalControl("Hitbox Y", {
        {label = "U", key = "HitboxUp"},
        {label = "D", key = "HitboxDown"}
    }, yPos)
    
    yPos = createDirectionalControl("Hitbox Z", {
        {label = "F", key = "HitboxFront"},
        {label = "B", key = "HitboxBack"}
    }, yPos)
    yPos = createTransparencySlider("Transparency", getgenv().HitboxSettings, "HitboxTransparency", yPos)
    yPos = createTransparencySlider("Preview Transp.", getgenv().HitboxSettings, "PreviewTransparency", yPos)
    
    -- Warning label for position offset
    local warningLabel = Instance.new("TextLabel")
    warningLabel.Size = UDim2.new(1, -20, 0, 40)
    warningLabel.Position = UDim2.new(0, 10, 0, yPos)
    warningLabel.BackgroundTransparency = 1
    warningLabel.Text = "⚠️ Position Offset (NOT RECOMMENDED - May cause bugs)"
    warningLabel.Font = Enum.Font.GothamBold
    warningLabel.TextSize = 12
    warningLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
    warningLabel.TextXAlignment = Enum.TextXAlignment.Left
    warningLabel.TextWrapped = true
    warningLabel.Parent = combatContent
    yPos = yPos + 45
    
    -- Position offset toggle
    yPos = createToggleButton("Use Position Offset", getgenv().HitboxSettings, "UsePositionOffset", yPos, nil)
    
    -- Position offset sliders (only show when enabled)
    local posXSliderY = yPos
    yPos = createSlider("Position X", getgenv().HitboxSettings, "HitboxPosX", -10, 10, yPos)
    local posYSliderY = yPos
    yPos = createSlider("Position Y", getgenv().HitboxSettings, "HitboxPosY", -10, 10, yPos)
    local posZSliderY = yPos
    yPos = createSlider("Position Z", getgenv().HitboxSettings, "HitboxPosZ", -10, 10, yPos)
    
    yPos = createCheckbox("Visibility Check", getgenv().HitboxSettings, "VisibilityCheck", yPos)
    yPos = createCheckbox("Team Check", getgenv().HitboxSettings, "TeamCheck", yPos)
    
    yPos = yPos + 10
    
    -- Aimlock Section
    local aimlockTitle = Instance.new("TextLabel")
    aimlockTitle.Size = UDim2.new(1, -20, 0, 30)
    aimlockTitle.Position = UDim2.new(0, 10, 0, yPos)
    aimlockTitle.BackgroundTransparency = 1
    aimlockTitle.Text = "AIMLOCK"
    aimlockTitle.Font = Enum.Font.GothamBlack
    aimlockTitle.TextSize = 16
    aimlockTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    aimlockTitle.TextXAlignment = Enum.TextXAlignment.Left
    aimlockTitle.Parent = combatContent
    yPos = yPos + 40
    
    yPos = createToggleButton("Aimlock", getgenv().AimlockSettings, "Enabled", yPos, function(enabled)
        if not aimlockLoaded then
            print("Loading Aimlock script from GitHub...")
            aimlockLoaded = loadScript(AIMLOCK_URL)
            if not aimlockLoaded then
                warn("Failed to load Aimlock script from GitHub")
                warn("URL: " .. AIMLOCK_URL)
                getgenv().AimlockSettings.Enabled = false
                return
            end
            print("Aimlock script loaded successfully!")
        end
        
        if not getgenv().AimlockControl then
            warn("AimlockControl not found after loading")
            getgenv().AimlockSettings.Enabled = false
            return
        end
        
        if enabled then
            getgenv().AimlockControl.Start()
        else
            getgenv().AimlockControl.Stop()
        end
    end)
    
    yPos = createSlider("Smoothness", getgenv().AimlockSettings, "Smoothness", 1, 20, yPos)
    yPos = createSlider("FOV Size", getgenv().AimlockSettings, "FOVSize", 50, 500, yPos)
    yPos = createCheckbox("Show FOV Circle", getgenv().AimlockSettings, "ShowFOV", yPos)
    yPos = createCheckbox("Visibility Check", getgenv().AimlockSettings, "VisibilityCheck", yPos)
    yPos = createCheckbox("Team Check", getgenv().AimlockSettings, "TeamCheck", yPos)
    
    yPos = yPos + 10
    
    -- Auto Defuse Section
    local autoDefuseTitle = Instance.new("TextLabel")
    autoDefuseTitle.Size = UDim2.new(1, -20, 0, 30)
    autoDefuseTitle.Position = UDim2.new(0, 10, 0, yPos)
    autoDefuseTitle.BackgroundTransparency = 1
    autoDefuseTitle.Text = "AUTO DEFUSE"
    autoDefuseTitle.Font = Enum.Font.GothamBlack
    autoDefuseTitle.TextSize = 16
    autoDefuseTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    autoDefuseTitle.TextXAlignment = Enum.TextXAlignment.Left
    autoDefuseTitle.Parent = combatContent
    yPos = yPos + 40
    
    yPos = createToggleButton("Auto Defuse", getgenv().AutoDefuseSettings, "Enabled", yPos, function(enabled)
        if not autoDefuseLoaded then
            print("Loading Auto Defuse script from GitHub...")
            autoDefuseLoaded = loadScript(AUTODEFUSE_URL)
            if not autoDefuseLoaded then
                warn("Failed to load Auto Defuse script from GitHub")
                warn("URL: " .. AUTODEFUSE_URL)
                getgenv().AutoDefuseSettings.Enabled = false
                return
            end
            print("Auto Defuse script loaded successfully!")
        end
        
        if not getgenv().AutoDefuseControl then
            warn("AutoDefuseControl not found after loading")
            getgenv().AutoDefuseSettings.Enabled = false
            return
        end
        
        if enabled then
            getgenv().AutoDefuseControl.Start()
        else
            getgenv().AutoDefuseControl.Stop()
        end
    end)
    
    combatContent.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

function CombatModule.Cleanup()
    if hitboxLoaded and getgenv().HitboxControl then
        getgenv().HitboxControl.Stop()
    end
    if aimlockLoaded and getgenv().AimlockControl then
        getgenv().AimlockControl.Stop()
    end
    if autoDefuseLoaded and getgenv().AutoDefuseControl then
        getgenv().AutoDefuseControl.Stop()
    end
end

return CombatModule
