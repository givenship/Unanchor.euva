-- Euva Layout Module
-- Main frame, sidebar, content area, grid lines

local TweenService = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Lighting = game:GetService("Lighting")

local Layout = {}
Layout.Theme = nil
Layout.Components = nil
Layout.Gui = nil
Layout.MainFrame = nil
Layout.Sidebar = nil
Layout.ContentArea = nil
Layout.ContentScroll = nil
Layout.ContentTitle = nil
Layout.TabContainer = nil
Layout.TabFrames = {}
Layout.TabButtons = {}
Layout.CurrentTab = nil
Layout.Blur = nil

local player = Players.LocalPlayer
local guiTransValue = 0.4

local function tween(obj, info, props)
    local t = TweenService:Create(obj, info, props)
    t:Play()
    return t
end

function Layout.Create(CoreGui)
    local THEME = Layout.Theme.Colors
    local CONFIG = Layout.Theme.Config
    local ASSETS = Layout.Theme.Assets
    
    -- Clean up old GUI
    local old = CoreGui:FindFirstChild("EuvaMainGUI")
    if old then old:Destroy() end
    
    local oldBlur = Lighting:FindFirstChild("EuvaBlur")
    if oldBlur then oldBlur:Destroy() end
    
    -- Create blur effect
    Layout.Blur = Instance.new("BlurEffect")
    Layout.Blur.Name = "EuvaBlur"
    Layout.Blur.Size = 0
    Layout.Blur.Parent = Lighting
    
    -- Create main ScreenGui
    Layout.Gui = Instance.new("ScreenGui")
    Layout.Gui.Name = "EuvaMainGUI"
    Layout.Gui.ResetOnSpawn = false
    Layout.Gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    Layout.Gui.Parent = CoreGui
    
    -- Outer lines container
    local outerLines = Instance.new("Frame")
    outerLines.Name = "OuterLines"
    outerLines.BackgroundTransparency = 1
    outerLines.Size = UDim2.fromScale(1, 1)
    outerLines.ZIndex = 5
    outerLines.Parent = Layout.Gui
    
    local function createOuterLine(size, pos)
        local f = Instance.new("Frame")
        f.BackgroundColor3 = THEME.Line
        f.BackgroundTransparency = 0.35
        f.BorderSizePixel = 0
        f.Size = size
        f.Position = pos
        f.ZIndex = 5
        f.Active = false
        f.Selectable = false
        f.Parent = outerLines
        return f
    end
    
    -- Outer border lines
    createOuterLine(UDim2.new(0, 820, 0, 1), UDim2.new(0.5, -410, 0.5, -260)) -- top
    createOuterLine(UDim2.new(0, 820, 0, 1), UDim2.new(0.5, -410, 0.5, 260))  -- bottom
    createOuterLine(UDim2.new(0, 1, 0, 520), UDim2.new(0.5, -410, 0.5, -260)) -- left
    createOuterLine(UDim2.new(0, 1, 0, 520), UDim2.new(0.5, 410, 0.5, -260))  -- right
    
    -- Main frame
    Layout.MainFrame = Instance.new("Frame")
    Layout.MainFrame.Name = "MainFrame"
    Layout.MainFrame.Size = UDim2.fromOffset(CONFIG.GuiSize.Width, CONFIG.GuiSize.Height)
    Layout.MainFrame.Position = UDim2.fromScale(0.5, 0.5)
    Layout.MainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    Layout.MainFrame.BackgroundColor3 = THEME.Base
    Layout.MainFrame.BorderSizePixel = 0
    Layout.MainFrame.ClipsDescendants = true
    Layout.MainFrame.Visible = false
    Layout.MainFrame.BackgroundTransparency = guiTransValue * 0.7
    Layout.MainFrame.Parent = Layout.Gui
    
    local mainCorner = Instance.new("UICorner")
    mainCorner.CornerRadius = UDim.new(0, 12)
    mainCorner.Parent = Layout.MainFrame
    
    -- Grid lines
    Layout.CreateGridLines()
    
    -- Gradient background
    local gradient = Instance.new("Frame")
    gradient.Name = "Gradient"
    gradient.Size = UDim2.fromScale(1, 1)
    gradient.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    gradient.BackgroundTransparency = 0.85
    gradient.BorderSizePixel = 0
    gradient.ZIndex = 1
    gradient.Parent = Layout.MainFrame
    
    local gradientUI = Instance.new("UIGradient")
    gradientUI.Color = ColorSequence.new{
        ColorSequenceKeypoint.new(0, THEME.Base),
        ColorSequenceKeypoint.new(1, Color3.fromRGB(255, 245, 248))
    }
    gradientUI.Rotation = 45
    gradientUI.Parent = gradient
    
    -- Intro line for animation
    Layout.IntroLine = Instance.new("Frame")
    Layout.IntroLine.Name = "IntroLine"
    Layout.IntroLine.AnchorPoint = Vector2.new(0.5, 0.5)
    Layout.IntroLine.Position = UDim2.fromScale(0.5, 0.5)
    Layout.IntroLine.Size = UDim2.fromOffset(0, 2)
    Layout.IntroLine.BackgroundColor3 = THEME.Line
    Layout.IntroLine.BackgroundTransparency = 0.1
    Layout.IntroLine.BorderSizePixel = 0
    Layout.IntroLine.ZIndex = 999
    Layout.IntroLine.Parent = Layout.Gui
    
    -- Create sidebar
    Layout.CreateSidebar()
    
    -- Create content area
    Layout.CreateContentArea()
    
    -- Create top buttons
    Layout.CreateTopButtons()
    
    -- Setup dragging
    Layout.SetupDragging()
    
    return Layout.Gui
end

function Layout.CreateGridLines()
    local THEME = Layout.Theme.Colors
    
    -- Vertical line at sidebar edge (x=180)
    local vLine1 = Instance.new("Frame")
    vLine1.Size = UDim2.new(0, 1, 1, 0)
    vLine1.Position = UDim2.new(0, 180, 0, 0)
    vLine1.BackgroundColor3 = THEME.Line
    vLine1.BackgroundTransparency = 0.35
    vLine1.BorderSizePixel = 0
    vLine1.ZIndex = 70
    vLine1.Parent = Layout.MainFrame

    -- Vertical line at content divider (x=490)
    local vLine2 = Instance.new("Frame")
    vLine2.Size = UDim2.new(0, 1, 0, 235)
    vLine2.Position = UDim2.new(0, 490, 0, 60)
    vLine2.BackgroundColor3 = THEME.Line
    vLine2.BackgroundTransparency = 0.35
    vLine2.BorderSizePixel = 0
    vLine2.ZIndex = 70
    vLine2.Parent = Layout.MainFrame

    -- Horizontal line at header separator (y=60)
    local hLine1 = Instance.new("Frame")
    hLine1.Size = UDim2.new(1, -190, 0, 1)
    hLine1.Position = UDim2.new(0, 190, 0, 60)
    hLine1.BackgroundColor3 = THEME.Line
    hLine1.BackgroundTransparency = 0.35
    hLine1.BorderSizePixel = 0
    hLine1.ZIndex = 70
    hLine1.Parent = Layout.MainFrame

    -- Horizontal line at content divider (y=295)
    local hLine2 = Instance.new("Frame")
    hLine2.Size = UDim2.new(1, -190, 0, 1)
    hLine2.Position = UDim2.new(0, 190, 0, 295)
    hLine2.BackgroundColor3 = THEME.Line
    hLine2.BackgroundTransparency = 0.35
    hLine2.BorderSizePixel = 0
    hLine2.ZIndex = 70
    hLine2.Parent = Layout.MainFrame
end

function Layout.CreateSidebar()
    local THEME = Layout.Theme.Colors
    local ASSETS = Layout.Theme.Assets
    
    Layout.Sidebar = Instance.new("Frame")
    Layout.Sidebar.Name = "Sidebar"
    Layout.Sidebar.Size = UDim2.new(0, 180, 1, 0)
    Layout.Sidebar.BackgroundTransparency = 1
    Layout.Sidebar.ZIndex = 10
    Layout.Sidebar.Parent = Layout.MainFrame
    
    -- Logo
    local logo = Instance.new("ImageLabel")
    logo.Name = "EuvaLogo"
    logo.Size = UDim2.new(0, 192, 0, 188)
    logo.Position = UDim2.new(0, -11, 0, -73)
    logo.BackgroundTransparency = 1
    logo.Image = ASSETS.Logo
    logo.ImageTransparency = 0
    logo.ZIndex = 11
    logo.Parent = Layout.Sidebar
    
    -- Tab container
    Layout.TabContainer = Instance.new("Frame")
    Layout.TabContainer.Name = "TabContainer"
    Layout.TabContainer.Size = UDim2.new(1, -20, 1, -190)
    Layout.TabContainer.Position = UDim2.new(0, 10, 0, 80)
    Layout.TabContainer.BackgroundTransparency = 1
    Layout.TabContainer.ZIndex = 11
    Layout.TabContainer.Parent = Layout.Sidebar
    
    local tabLayout = Instance.new("UIListLayout")
    tabLayout.SortOrder = Enum.SortOrder.LayoutOrder
    tabLayout.Padding = UDim.new(0, 8)
    tabLayout.Parent = Layout.TabContainer
    
    -- User panel
    Layout.CreateUserPanel()
    
    -- Drag toggle button
    Layout.CreateDragToggle()
end

function Layout.CreateContentArea()
    local THEME = Layout.Theme.Colors
    
    Layout.ContentArea = Instance.new("Frame")
    Layout.ContentArea.Name = "ContentArea"
    Layout.ContentArea.Size = UDim2.new(1, -200, 1, -40)
    Layout.ContentArea.Position = UDim2.new(0, 190, 0, 20)
    Layout.ContentArea.BackgroundTransparency = 1
    Layout.ContentArea.ZIndex = 10
    Layout.ContentArea.Parent = Layout.MainFrame
    
    -- Content title
    Layout.ContentTitle = Instance.new("TextLabel")
    Layout.ContentTitle.Name = "ContentTitle"
    Layout.ContentTitle.Size = UDim2.new(1, -280, 0, 40)
    Layout.ContentTitle.BackgroundTransparency = 1
    Layout.ContentTitle.Text = "Welcome"
    Layout.ContentTitle.Font = Enum.Font.Code
    Layout.ContentTitle.TextSize = 28
    Layout.ContentTitle.TextColor3 = THEME.Text
    Layout.ContentTitle.TextXAlignment = Enum.TextXAlignment.Left
    Layout.ContentTitle.ZIndex = 20
    Layout.ContentTitle.Parent = Layout.ContentArea
    
    -- Server info
    Layout.CreateServerInfo()
    
    -- Content scroll frame
    Layout.ContentScroll = Instance.new("ScrollingFrame")
    Layout.ContentScroll.Name = "ContentScroll"
    Layout.ContentScroll.Size = UDim2.new(1, 0, 1, -60)
    Layout.ContentScroll.Position = UDim2.new(0, 0, 0, 50)
    Layout.ContentScroll.BackgroundTransparency = 1
    Layout.ContentScroll.BorderSizePixel = 0
    Layout.ContentScroll.ScrollBarThickness = 4
    Layout.ContentScroll.ScrollBarImageColor3 = Color3.fromRGB(200, 180, 190)
    Layout.ContentScroll.CanvasSize = UDim2.new(0, 0, 0, 0)
    Layout.ContentScroll.AutomaticCanvasSize = Enum.AutomaticSize.Y
    Layout.ContentScroll.ZIndex = 20
    Layout.ContentScroll.Parent = Layout.ContentArea
    
    local contentLayout = Instance.new("UIListLayout")
    contentLayout.SortOrder = Enum.SortOrder.LayoutOrder
    contentLayout.Padding = UDim.new(0, 15)
    contentLayout.Parent = Layout.ContentScroll
end

function Layout.CreateServerInfo()
    local THEME = Layout.Theme.Colors
    
    local serverInfoFrame = Instance.new("Frame")
    serverInfoFrame.Name = "ServerInfoFrame"
    serverInfoFrame.Size = UDim2.fromOffset(260, 54)
    serverInfoFrame.Position = UDim2.new(1, -450, 0, 0)
    serverInfoFrame.BackgroundColor3 = THEME.Soft
    serverInfoFrame.BackgroundTransparency = 0.35
    serverInfoFrame.BorderSizePixel = 0
    serverInfoFrame.ZIndex = 25
    serverInfoFrame.Parent = Layout.ContentArea
    
    local sCorner = Instance.new("UICorner")
    sCorner.CornerRadius = UDim.new(0, 8)
    sCorner.Parent = serverInfoFrame
    
    local sPad = Instance.new("UIPadding")
    sPad.PaddingLeft = UDim.new(0, 10)
    sPad.PaddingRight = UDim.new(0, 10)
    sPad.PaddingTop = UDim.new(0, 6)
    sPad.PaddingBottom = UDim.new(0, 6)
    sPad.Parent = serverInfoFrame
    
    local sLayout = Instance.new("UIListLayout")
    sLayout.FillDirection = Enum.FillDirection.Vertical
    sLayout.SortOrder = Enum.SortOrder.LayoutOrder
    sLayout.Padding = UDim.new(0, 2)
    sLayout.Parent = serverInfoFrame
    
    Layout.GameNameLabel = Instance.new("TextLabel")
    Layout.GameNameLabel.BackgroundTransparency = 1
    Layout.GameNameLabel.Size = UDim2.new(1, 0, 0, 14)
    Layout.GameNameLabel.Font = Enum.Font.Gotham
    Layout.GameNameLabel.TextSize = 12
    Layout.GameNameLabel.TextColor3 = THEME.TextMuted
    Layout.GameNameLabel.TextXAlignment = Enum.TextXAlignment.Right
    Layout.GameNameLabel.ZIndex = 26
    Layout.GameNameLabel.Parent = serverInfoFrame
    
    local jobRow = Instance.new("Frame")
    jobRow.BackgroundTransparency = 1
    jobRow.Size = UDim2.new(1, 0, 0, 14)
    jobRow.ZIndex = 26
    jobRow.Parent = serverInfoFrame
    
    Layout.JobTextBox = Instance.new("TextBox")
    Layout.JobTextBox.BackgroundTransparency = 1
    Layout.JobTextBox.Size = UDim2.new(1, -56, 1, 0)
    Layout.JobTextBox.ClearTextOnFocus = false
    Layout.JobTextBox.TextEditable = true
    Layout.JobTextBox.Font = Enum.Font.Gotham
    Layout.JobTextBox.TextSize = 12
    Layout.JobTextBox.TextColor3 = THEME.TextMuted
    Layout.JobTextBox.TextXAlignment = Enum.TextXAlignment.Right
    Layout.JobTextBox.ZIndex = 26
    Layout.JobTextBox.Parent = jobRow
    
    local copyJob = Instance.new("TextButton")
    copyJob.Size = UDim2.new(0, 56, 1, 0)
    copyJob.Position = UDim2.new(1, -56, 0, 0)
    copyJob.BackgroundTransparency = 1
    copyJob.Text = "[Copy]"
    copyJob.Font = Enum.Font.GothamBold
    copyJob.TextSize = 12
    copyJob.TextColor3 = THEME.Text
    copyJob.TextWrapped = true
    copyJob.ZIndex = 27
    copyJob.Parent = jobRow
    
    Layout.PlayerCountLabel = Instance.new("TextLabel")
    Layout.PlayerCountLabel.BackgroundTransparency = 1
    Layout.PlayerCountLabel.Size = UDim2.new(1, 0, 0, 14)
    Layout.PlayerCountLabel.Font = Enum.Font.Gotham
    Layout.PlayerCountLabel.TextSize = 12
    Layout.PlayerCountLabel.TextColor3 = THEME.TextMuted
    Layout.PlayerCountLabel.TextXAlignment = Enum.TextXAlignment.Right
    Layout.PlayerCountLabel.ZIndex = 26
    Layout.PlayerCountLabel.Parent = serverInfoFrame
    
    copyJob.MouseButton1Click:Connect(function()
        local ok = Layout.Components.TryClipboard(Layout.JobTextBox.Text)
        if not ok then
            Layout.Components.Notify("Clipboard blocked. Click JobId box and Ctrl+C.")
            Layout.JobTextBox:CaptureFocus()
        end
    end)
end

function Layout.CreateUserPanel()
    local THEME = Layout.Theme.Colors
    
    local userPanel = Instance.new("Frame")
    userPanel.Name = "UserPanel"
    userPanel.Size = UDim2.new(1, -20, 0, 90)
    userPanel.Position = UDim2.new(0, 10, 1, -100)
    userPanel.BackgroundTransparency = 1
    userPanel.ZIndex = 20
    userPanel.Parent = Layout.Sidebar
    
    local userPanelLayout = Instance.new("UIListLayout")
    userPanelLayout.FillDirection = Enum.FillDirection.Vertical
    userPanelLayout.SortOrder = Enum.SortOrder.LayoutOrder
    userPanelLayout.Padding = UDim.new(0, 2)
    userPanelLayout.Parent = userPanel
    
    local userTopRow = Instance.new("Frame")
    userTopRow.BackgroundTransparency = 1
    userTopRow.Size = UDim2.new(1, 0, 0, 40)
    userTopRow.ZIndex = 20
    userTopRow.Parent = userPanel
    
    local avatar = Instance.new("ImageLabel")
    avatar.Size = UDim2.fromOffset(36, 36)
    avatar.Position = UDim2.fromOffset(0, 2)
    avatar.BackgroundTransparency = 1
    avatar.ZIndex = 21
    avatar.Parent = userTopRow
    
    local aCorner = Instance.new("UICorner")
    aCorner.CornerRadius = UDim.new(1, 0)
    aCorner.Parent = avatar
    
    local nameCol = Instance.new("Frame")
    nameCol.BackgroundTransparency = 1
    nameCol.Position = UDim2.fromOffset(42, 0)
    nameCol.Size = UDim2.new(1, -42, 1, 0)
    nameCol.ZIndex = 21
    nameCol.Parent = userTopRow
    
    local nameLayout = Instance.new("UIListLayout")
    nameLayout.FillDirection = Enum.FillDirection.Vertical
    nameLayout.SortOrder = Enum.SortOrder.LayoutOrder
    nameLayout.Padding = UDim.new(0, 0)
    nameLayout.Parent = nameCol
    
    local usernameLabel = Instance.new("TextLabel")
    usernameLabel.BackgroundTransparency = 1
    usernameLabel.Size = UDim2.new(1, 0, 0, 18)
    usernameLabel.Font = Enum.Font.GothamBold
    usernameLabel.TextSize = 13
    usernameLabel.TextColor3 = THEME.Text
    usernameLabel.TextXAlignment = Enum.TextXAlignment.Left
    usernameLabel.Text = "@" .. player.Name
    usernameLabel.ZIndex = 21
    usernameLabel.Parent = nameCol
    
    local displayLabel = Instance.new("TextLabel")
    displayLabel.BackgroundTransparency = 1
    displayLabel.Size = UDim2.new(1, 0, 0, 18)
    displayLabel.Font = Enum.Font.Gotham
    displayLabel.TextSize = 12
    displayLabel.TextColor3 = THEME.TextMuted
    displayLabel.TextXAlignment = Enum.TextXAlignment.Left
    displayLabel.Text = player.DisplayName .. "  |  ID: " .. player.UserId
    displayLabel.ZIndex = 21
    displayLabel.Parent = nameCol
    
    Layout.StatsLabel = Instance.new("TextLabel")
    Layout.StatsLabel.BackgroundTransparency = 1
    Layout.StatsLabel.Size = UDim2.new(1, 0, 0, 16)
    Layout.StatsLabel.Font = Enum.Font.Gotham
    Layout.StatsLabel.TextSize = 11
    Layout.StatsLabel.TextColor3 = THEME.TextMuted
    Layout.StatsLabel.TextXAlignment = Enum.TextXAlignment.Left
    Layout.StatsLabel.ZIndex = 21
    Layout.StatsLabel.Parent = userPanel
    
    Layout.MoneyLabel = Instance.new("TextLabel")
    Layout.MoneyLabel.BackgroundTransparency = 1
    Layout.MoneyLabel.Size = UDim2.new(1, 0, 0, 16)
    Layout.MoneyLabel.Font = Enum.Font.Gotham
    Layout.MoneyLabel.TextSize = 11
    Layout.MoneyLabel.TextColor3 = THEME.TextMuted
    Layout.MoneyLabel.TextXAlignment = Enum.TextXAlignment.Left
    Layout.MoneyLabel.ZIndex = 21
    Layout.MoneyLabel.Parent = userPanel
    
    -- Load avatar
    task.spawn(function()
        local thumb, _ = Players:GetUserThumbnailAsync(player.UserId, Enum.ThumbnailType.HeadShot, Enum.ThumbnailSize.Size100x100)
        avatar.Image = thumb
    end)
end

function Layout.CreateDragToggle()
    local ASSETS = Layout.Theme.Assets
    
    local dragButton = Instance.new("ImageButton")
    dragButton.Name = "DragToggle"
    dragButton.Size = UDim2.fromOffset(26, 26)
    dragButton.Position = UDim2.new(1, -36, 1, -130)
    dragButton.BackgroundTransparency = 1
    dragButton.Image = ASSETS.MoveIcon
    dragButton.ImageTransparency = 0.2
    dragButton.ZIndex = 40
    dragButton.Parent = Layout.Sidebar
    
    local dragStroke = Instance.new("UIStroke")
    dragStroke.Thickness = 2
    dragStroke.Transparency = 1
    dragStroke.Color = Color3.fromRGB(244, 167, 187)
    dragStroke.Parent = dragButton
    
    Layout.DragEnabled = false
    
    dragButton.MouseButton1Click:Connect(function()
        Layout.DragEnabled = not Layout.DragEnabled
        dragStroke.Transparency = Layout.DragEnabled and 0 or 1
        dragButton.ImageTransparency = Layout.DragEnabled and 0 or 0.2
    end)
end

function Layout.CreateTopButtons()
    local THEME = Layout.Theme.Colors
    local CONFIG = Layout.Theme.Config
    
    local function topBtn(symbol, xOff)
        local btn = Instance.new("TextButton")
        btn.Size = UDim2.fromOffset(40, 40)
        btn.Position = UDim2.new(1, xOff, 0, 10)
        btn.BackgroundColor3 = THEME.Soft
        btn.BorderSizePixel = 0
        btn.Text = symbol
        btn.Font = Enum.Font.GothamBold
        btn.TextSize = 24
        btn.TextColor3 = THEME.Text
        btn.ZIndex = 80
        btn.Parent = Layout.MainFrame
        
        local c = Instance.new("UICorner")
        c.CornerRadius = UDim.new(0, 8)
        c.Parent = btn
        return btn
    end
    
    local closeButton = topBtn("×", -50)
    local minimizeButton = topBtn("−", -100)
    
    -- Discord button
    local discordButton = Instance.new("TextButton")
    discordButton.Size = UDim2.fromOffset(100, 40)
    discordButton.Position = UDim2.new(1, -160, 0, 10)
    discordButton.BackgroundColor3 = THEME.Discord
    discordButton.BorderSizePixel = 0
    discordButton.Text = "Discord"
    discordButton.Font = Enum.Font.GothamBold
    discordButton.TextSize = 14
    discordButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    discordButton.ZIndex = 80
    discordButton.Parent = Layout.MainFrame
    
    local discordCorner = Instance.new("UICorner")
    discordCorner.CornerRadius = UDim.new(0, 8)
    discordCorner.Parent = discordButton
    
    discordButton.MouseButton1Click:Connect(function()
        if not Layout.Components.TryClipboard(CONFIG.DiscordInvite) then
            Layout.Components.Notify("Clipboard blocked. Link: " .. CONFIG.DiscordInvite)
        end
    end)
    
    closeButton.MouseButton1Click:Connect(function()
        if Layout.Blur then Layout.Blur:Destroy() end
        Layout.Gui:Destroy()
    end)
    
    local minimized = false
    minimizeButton.MouseButton1Click:Connect(function()
        minimized = not minimized
        if minimized then
            tween(Layout.MainFrame, TweenInfo.new(0.25, Enum.EasingStyle.Quad), {Size = UDim2.fromOffset(220, 70)})
            minimizeButton.Text = "+"
        else
            tween(Layout.MainFrame, TweenInfo.new(0.25, Enum.EasingStyle.Quad), {Size = UDim2.fromOffset(CONFIG.GuiSize.Width, CONFIG.GuiSize.Height)})
            minimizeButton.Text = "−"
        end
    end)
end

function Layout.SetupDragging()
    local CoreGui = game:GetService("CoreGui")
    local dragging, dragStart, startPos = false, nil, nil
    
    Layout.MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType ~= Enum.UserInputType.MouseButton1 then return end
        
        local mouseY = input.Position.Y
        local frameTop = Layout.MainFrame.AbsolutePosition.Y
        if mouseY - frameTop > 60 then return end
        
        local objs = CoreGui:GetGuiObjectsAtPosition(input.Position.X, input.Position.Y)
        for _, o in ipairs(objs) do
            if o:IsA("TextButton") or o:IsA("ImageButton") or o:IsA("TextBox") or o:IsA("ScrollingFrame") then
                return
            end
        end
        
        dragging = true
        dragStart = input.Position
        startPos = Layout.MainFrame.Position
    end)
    
    Layout.MainFrame.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType ~= Enum.UserInputType.MouseMovement then return end
        if not dragging then return end
        local delta = input.Position - dragStart
        Layout.MainFrame.Position = UDim2.new(
            startPos.X.Scale, startPos.X.Offset + delta.X,
            startPos.Y.Scale, startPos.Y.Offset + delta.Y
        )
    end)
end

function Layout.CreateTab(tabName)
    local THEME = Layout.Theme.Colors
    
    local tabBtn = Instance.new("TextButton")
    tabBtn.Size = UDim2.new(1, 0, 0, 36)
    tabBtn.BackgroundColor3 = THEME.Soft
    tabBtn.BackgroundTransparency = 1
    tabBtn.BorderSizePixel = 0
    tabBtn.AutoButtonColor = false
    tabBtn.Text = tabName
    tabBtn.Font = Enum.Font.Gotham
    tabBtn.TextSize = 14
    tabBtn.TextColor3 = THEME.TextMuted
    tabBtn.TextXAlignment = Enum.TextXAlignment.Left
    tabBtn.ZIndex = 12
    tabBtn.Parent = Layout.TabContainer
    Layout.TabButtons[tabName] = tabBtn
    
    local pad = Instance.new("UIPadding")
    pad.PaddingLeft = UDim.new(0, 15)
    pad.Parent = tabBtn
    
    local tabFrame = Instance.new("Frame")
    tabFrame.Name = tabName .. "Content"
    tabFrame.BackgroundTransparency = 1
    tabFrame.Size = UDim2.new(1, 0, 1, 0)
    tabFrame.Visible = false
    tabFrame.ZIndex = 22
    tabFrame.Parent = Layout.ContentScroll
    Layout.TabFrames[tabName] = tabFrame
    
    local lay = Instance.new("UIListLayout")
    lay.Padding = UDim.new(0, 12)
    lay.SortOrder = Enum.SortOrder.LayoutOrder
    lay.Parent = tabFrame
    
    local function select()
        for _, f in pairs(Layout.TabFrames) do f.Visible = false end
        for _, b in pairs(Layout.TabButtons) do
            b.BackgroundTransparency = 1
            b.TextColor3 = THEME.TextMuted
        end
        
        tabFrame.Visible = true
        tabBtn.BackgroundTransparency = 0
        tabBtn.TextColor3 = THEME.Text
        Layout.ContentTitle.Text = tabName
        Layout.CurrentTab = tabFrame
    end
    
    tabBtn.MouseButton1Click:Connect(select)
    
    if not Layout.CurrentTab then select() end
    return tabFrame
end

function Layout.SetGuiTransparency(value)
    guiTransValue = value
    Layout.MainFrame.BackgroundTransparency = guiTransValue * 0.7
end

function Layout.SetBlur(value)
    if Layout.Blur then
        Layout.Blur.Size = math.floor(value * 24)
    end
end

function Layout.PlayIntroAnimation()
    task.spawn(function()
        tween(Layout.IntroLine, TweenInfo.new(0.25, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Size = UDim2.fromOffset(820, 2)
        }).Completed:Wait()
        
        Layout.MainFrame.Size = UDim2.fromOffset(820, 2)
        Layout.MainFrame.Visible = true
        
        tween(Layout.MainFrame, TweenInfo.new(0.28, Enum.EasingStyle.Quad, Enum.EasingDirection.Out), {
            Size = UDim2.fromOffset(Layout.Theme.Config.GuiSize.Width, Layout.Theme.Config.GuiSize.Height)
        }).Completed:Wait()
        
        tween(Layout.IntroLine, TweenInfo.new(0.15), {BackgroundTransparency = 1}).Completed:Wait()
        Layout.IntroLine:Destroy()
    end)
end

function Layout.UpdateServerInfo()
    Layout.GameNameLabel.Text = "Game: " .. (game.Name or "Unknown")
    Layout.JobTextBox.Text = "JobId: " .. (game.JobId ~= "" and game.JobId or "Local/Studio")
    Layout.PlayerCountLabel.Text = "Players: " .. tostring(#Players:GetPlayers())
end

function Layout.StartStatsLoop()
    local fps = 60
    local acc, frames = 0, 0
    
    RunService.RenderStepped:Connect(function(dt)
        acc = acc + dt
        frames = frames + 1
        if acc >= 1 then
            fps = math.floor(frames / acc + 0.5)
            acc, frames = 0, 0
        end
    end)
    
    local function getStat(name)
        local ls = player:FindFirstChild("leaderstats")
        if not ls then return nil end
        local v = ls:FindFirstChild(name)
        if not v then return nil end
        if v:IsA("NumberValue") or v:IsA("IntValue") then
            return v.Value
        end
        return nil
    end
    
    task.spawn(function()
        while Layout.Gui and Layout.Gui.Parent do
            local lv = getStat("LV") or getStat("Level") or 0
            local wins = getStat("Wins") or 0
            local money = getStat("Money") or getStat("Cash") or 0
            
            Layout.StatsLabel.Text = ("FPS: %d  |  LV: %s  |  Wins: %s"):format(fps, tostring(lv), tostring(wins))
            Layout.MoneyLabel.Text = ("Money: %s"):format(tostring(money))
            task.wait(0.25)
        end
    end)
    
    Players.PlayerAdded:Connect(function() Layout.UpdateServerInfo() end)
    Players.PlayerRemoving:Connect(function() Layout.UpdateServerInfo() end)
    Layout.UpdateServerInfo()
end

return Layout
