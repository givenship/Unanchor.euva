-- Player Module
-- Features: Reset Character, Lock Jumppower, Noclip

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local UserInputService = game:GetService("UserInputService")
local StarterGui = game:GetService("StarterGui")
local LocalPlayer = Players.LocalPlayer

local PlayerModule = {}

-- Settings
getgenv().PlayerSettings = {
    ResetEnabled = false,
    LockJumppower = false,
    JumppowerValue = 50,
    Noclip = false
}

-- Connections
local jumppowerConnection = nil
local noclipConnection = nil

-- Enable Reset Character
local function enableReset()
    if getgenv().PlayerSettings.ResetEnabled then
        -- Method 1: Fire fall damage remote
        local success = pcall(function()
            local args = {"Damage", math.huge}
            ReplicatedStorage:WaitForChild("Remotes"):WaitForChild("FallDamage"):FireServer(unpack(args))
        end)
        
        if success then
            print("Reset character via fall damage")
        else
            -- Method 2: Enable CoreGui reset button
            pcall(function()
                StarterGui:SetCore("ResetButtonCallback", true)
                print("Reset button enabled")
            end)
        end
    end
end

-- Lock Jumppower
local function lockJumppower()
    if jumppowerConnection then
        jumppowerConnection:Disconnect()
        jumppowerConnection = nil
    end
    
    if getgenv().PlayerSettings.LockJumppower then
        jumppowerConnection = RunService.Heartbeat:Connect(function()
            if LocalPlayer.Character then
                local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
                if humanoid then
                    humanoid.UseJumpPower = false
                    humanoid.JumpHeight = getgenv().PlayerSettings.JumppowerValue
                end
            end
        end)
        print("JumpHeight locked to", getgenv().PlayerSettings.JumppowerValue)
    else
        if LocalPlayer.Character then
            local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
            if humanoid then
                humanoid.UseJumpPower = true
            end
        end
        print("JumpHeight lock disabled")
    end
end

-- Noclip
local function toggleNoclip()
    if noclipConnection then
        noclipConnection:Disconnect()
        noclipConnection = nil
    end
    
    if getgenv().PlayerSettings.Noclip then
        noclipConnection = RunService.Stepped:Connect(function()
            if LocalPlayer.Character then
                for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                    if part:IsA("BasePart") then
                        part.CanCollide = false
                    end
                end
                
                local map = workspace:FindFirstChild("Map")
                if map then
                    for _, part in pairs(map:GetDescendants()) do
                        if part:IsA("BasePart") then
                            part.CanCollide = true
                        end
                    end
                end
            end
        end)
        print("Noclip enabled (excluding Map)")
    else
        if LocalPlayer.Character then
            for _, part in pairs(LocalPlayer.Character:GetDescendants()) do
                if part:IsA("BasePart") then
                    part.CanCollide = true
                end
            end
        end
        print("Noclip disabled")
    end
end

function PlayerModule.CreateUI(parent)
    local playerContent = Instance.new("ScrollingFrame")
    playerContent.Size = UDim2.new(1, 0, 1, 0)
    playerContent.BackgroundTransparency = 1
    playerContent.BorderSizePixel = 0
    playerContent.ScrollBarThickness = 4
    playerContent.Parent = parent
    
    local yPos = 10
    
    -- Helper: toggle button
    local function createToggleButton(name, settingsTable, settingKey, position, callback)
        local button = Instance.new("TextButton")
        button.Size = UDim2.new(1, -20, 0, 35)
        button.Position = UDim2.new(0, 10, 0, position)
        button.BackgroundColor3 = settingsTable[settingKey] and Color3.fromRGB(30, 144, 255) or Color3.fromRGB(60, 60, 60)
        button.BorderSizePixel = 0
        button.Text = name .. ": " .. (settingsTable[settingKey] and "ENABLED" or "DISABLED")
        button.Font = Enum.Font.GothamBold
        button.TextSize = 14
        button.TextColor3 = Color3.fromRGB(255, 255, 255)
        button.Parent = playerContent
        
        button.MouseButton1Click:Connect(function()
            settingsTable[settingKey] = not settingsTable[settingKey]
            button.BackgroundColor3 = settingsTable[settingKey] and Color3.fromRGB(30, 144, 255) or Color3.fromRGB(60, 60, 60)
            button.Text = name .. ": " .. (settingsTable[settingKey] and "ENABLED" or "DISABLED")
            if callback then callback(settingsTable[settingKey]) end
        end)
        
        return position + 45
    end
    
    -- Helper: slider
    local function createSlider(name, settingsTable, settingKey, minVal, maxVal, position)
        local container = Instance.new("Frame")
        container.Size = UDim2.new(1, -20, 0, 50)
        container.Position = UDim2.new(0, 10, 0, position)
        container.BackgroundTransparency = 1
        container.Parent = playerContent
        
        local label = Instance.new("TextLabel")
        label.Size = UDim2.new(0, 100, 0, 20)
        label.Position = UDim2.new(0, 0, 0, 5)
        label.BackgroundTransparency = 1
        label.Text = name .. ": " .. settingsTable[settingKey]
        label.Font = Enum.Font.GothamBold
        label.TextSize = 12
        label.TextColor3 = Color3.fromRGB(255, 255, 255)
        label.TextXAlignment = Enum.TextXAlignment.Left
        label.Parent = container
        
        local sliderBg = Instance.new("Frame")
        sliderBg.Size = UDim2.new(1, -110, 0, 20)
        sliderBg.Position = UDim2.new(0, 105, 0, 25)
        sliderBg.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
        sliderBg.BorderSizePixel = 1
        sliderBg.BorderColor3 = Color3.fromRGB(255, 255, 255)
        sliderBg.Parent = container
        
        local sliderFill = Instance.new("Frame")
        sliderFill.Size = UDim2.new((settingsTable[settingKey] - minVal) / (maxVal - minVal), 0, 1, 0)
        sliderFill.BackgroundColor3 = Color3.fromRGB(30, 144, 255)
        sliderFill.BorderSizePixel = 0
        sliderFill.Parent = sliderBg
        
        local sliderButton = Instance.new("TextButton")
        sliderButton.Size = UDim2.new(1, 0, 1, 0)
        sliderButton.BackgroundTransparency = 1
        sliderButton.Text = ""
        sliderButton.Parent = sliderBg
        
        local dragging = false
        
        sliderButton.MouseButton1Down:Connect(function()
            dragging = true
        end)
        
        UserInputService.InputEnded:Connect(function(input)
            if input.UserInputType == Enum.UserInputType.MouseButton1 then
                dragging = false
            end
        end)
        
        RunService.RenderStepped:Connect(function()
            if dragging then
                local mouse = UserInputService:GetMouseLocation()
                local relativeX = math.clamp(mouse.X - sliderBg.AbsolutePosition.X, 0, sliderBg.AbsoluteSize.X)
                local percentage = relativeX / sliderBg.AbsoluteSize.X
                local value = math.floor(minVal + (maxVal - minVal) * percentage)
                
                settingsTable[settingKey] = value
                sliderFill.Size = UDim2.new((value - minVal) / (maxVal - minVal), 0, 1, 0)
                label.Text = name .. ": " .. value
                
                if settingKey == "JumppowerValue" and getgenv().PlayerSettings.LockJumppower then
                    lockJumppower()
                end
            end
        end)
        
        return position + 60
    end
    
    -- RESET CHARACTER Section
    local resetTitle = Instance.new("TextLabel")
    resetTitle.Size = UDim2.new(1, -20, 0, 30)
    resetTitle.Position = UDim2.new(0, 10, 0, yPos)
    resetTitle.BackgroundTransparency = 1
    resetTitle.Text = "RESET CHARACTER"
    resetTitle.Font = Enum.Font.GothamBlack
    resetTitle.TextSize = 16
    resetTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    resetTitle.TextXAlignment = Enum.TextXAlignment.Left
    resetTitle.Parent = playerContent
    yPos = yPos + 40
    
    yPos = createToggleButton("Enable Reset", getgenv().PlayerSettings, "ResetEnabled", yPos, enableReset)
    
    yPos = yPos + 10
    
    -- JUMPPOWER Section
    local jumpTitle = Instance.new("TextLabel")
    jumpTitle.Size = UDim2.new(1, -20, 0, 30)
    jumpTitle.Position = UDim2.new(0, 10, 0, yPos)
    jumpTitle.BackgroundTransparency = 1
    jumpTitle.Text = "JUMP HEIGHT"
    jumpTitle.Font = Enum.Font.GothamBlack
    jumpTitle.TextSize = 16
    jumpTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    jumpTitle.TextXAlignment = Enum.TextXAlignment.Left
    jumpTitle.Parent = playerContent
    yPos = yPos + 40
    
    yPos = createToggleButton("Lock JumpHeight", getgenv().PlayerSettings, "LockJumppower", yPos, lockJumppower)
    yPos = createSlider("JumpHeight Value", getgenv().PlayerSettings, "JumppowerValue", 1, 200, yPos)
    
    yPos = yPos + 10
    
    -- NOCLIP Section
    local noclipTitle = Instance.new("TextLabel")
    noclipTitle.Size = UDim2.new(1, -20, 0, 30)
    noclipTitle.Position = UDim2.new(0, 10, 0, yPos)
    noclipTitle.BackgroundTransparency = 1
    noclipTitle.Text = "NOCLIP"
    noclipTitle.Font = Enum.Font.GothamBlack
    noclipTitle.TextSize = 16
    noclipTitle.TextColor3 = Color3.fromRGB(255, 255, 255)
    noclipTitle.TextXAlignment = Enum.TextXAlignment.Left
    noclipTitle.Parent = playerContent
    yPos = yPos + 40
    
    yPos = createToggleButton("Noclip", getgenv().PlayerSettings, "Noclip", yPos, toggleNoclip)
    
    playerContent.CanvasSize = UDim2.new(0, 0, 0, yPos + 20)
end

function PlayerModule.Cleanup()
    if jumppowerConnection then
        jumppowerConnection:Disconnect()
    end
    if noclipConnection then
        noclipConnection:Disconnect()
    end
end

return PlayerModule
